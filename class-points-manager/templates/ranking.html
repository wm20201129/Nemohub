{% extends "base.html" %}

{% block title %}è£èª‰é¾™è™æ¦œ - å®æ—¶ç«æŠ€çœ‹æ¿{% endblock %}

{% block content %}
<style>
    :root {
        --primary: #4f46e5; --secondary: #ec4899; --accent: #8b5cf6;
        --bg: #f8fafc; --card-bg: #ffffff;
        --text-main: #1e293b; --text-muted: #64748b;
        --gold: linear-gradient(135deg, #fcd34d 0%, #fbbf24 50%, #d97706 100%);
        --silver: linear-gradient(135deg, #e2e8f0 0%, #94a3b8 50%, #475569 100%);
        --bronze: linear-gradient(135deg, #fed7aa 0%, #fb923c 50%, #9a3412 100%);
    }

    body { background: #f1f5f9; font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif; color: var(--text-main); }

    .glass-card {
        background: var(--card-bg); border-radius: 24px; border: 1px solid rgba(255,255,255,0.8);
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02), 0 20px 25px -5px rgba(0,0,0,0.05);
    }

    /* å‡çº§ç‰ˆä¸»é¡µ UI æ ·å¼ */
    .ranking-header {
        display: flex; justify-content: space-between; align-items: center; padding: 25px 40px;
        margin-bottom: 30px; background: white; border-radius: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.03);
    }
    .brand { display: flex; align-items: center; gap: 20px; }
    .brand-icon {
        width: 55px; height: 55px; background: var(--primary); border-radius: 18px;
        display: flex; align-items: center; justify-content: center; color: white; font-size: 26px;
        box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);
    }
    .brand-text h2 { margin: 0; font-size: 22px; font-weight: 900; letter-spacing: -0.5px; }
    .brand-text p { margin: 4px 0 0; font-size: 12px; color: var(--text-muted); font-weight: 700; text-transform: uppercase; }

    .nav-actions { display: flex; gap: 12px; }
    .btn-glass {
        padding: 12px 20px; border-radius: 15px; border: none; font-weight: 800; font-size: 13px;
        cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.3s; color: white;
    }
    .btn-glass:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }

    .section-head { margin: 0 0 20px 10px; display: flex; align-items: center; gap: 10px; font-size: 18px; font-weight: 900; }
    .bounty-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; margin-bottom: 40px; }

    .bounty-card-v2 {
        background: white; border-radius: 24px; padding: 24px; position: relative; transition: 0.3s;
        border: 2px solid transparent; overflow: hidden;
    }
    .bounty-card-v2:hover { border-color: var(--primary); transform: translateY(-5px); }
    .bounty-type-tag {
        position: absolute; top: 0; right: 0; padding: 6px 15px; font-size: 10px; font-weight: 900;
        color: white; border-bottom-left-radius: 20px;
    }

    .main-grid { display: grid; grid-template-columns: 360px 1fr; gap: 30px; align-items: start; }

    .timeline-card { padding: 30px; background: white; border-radius: 30px; }
    .timeline-list { margin-top: 25px; position: relative; }
    .event-item { position: relative; padding-left: 35px; margin-bottom: 30px; }
    .event-item::before { content: ''; position: absolute; left: 0; top: 0; bottom: -30px; width: 2px; background: #f1f5f9; }
    .event-item:last-child::before { display: none; }
    .event-icon {
        position: absolute; left: -6px; top: 4px; width: 14px; height: 14px; border-radius: 50%;
        background: white; border: 3px solid var(--primary); z-index: 1;
    }

    .rank-card { background: white; border-radius: 35px; overflow: hidden; }
    .rank-tabs { padding: 20px 40px; background: #fafafa; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
    .pill-group { background: #f1f5f9; padding: 5px; border-radius: 15px; display: flex; gap: 5px; }
    .pill-btn { padding: 10px 25px; border-radius: 12px; border: none; background: transparent; cursor: pointer; font-size: 14px; font-weight: 800; color: var(--text-muted); transition: 0.3s; }
    .pill-btn.active { background: white; color: var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

    .data-table { width: 100%; border-collapse: collapse; }
    .data-table th { padding: 20px 40px; text-align: left; font-size: 11px; font-weight: 900; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; }
    .data-table td { padding: 20px 40px; border-bottom: 1px solid #f8fafc; }

    .rank-badge {
        width: 45px; height: 45px; border-radius: 15px; display: flex; align-items: center; justify-content: center;
        font-weight: 950; font-size: 20px; color: white;
    }
    .rank-1 { background: var(--gold); box-shadow: 0 10px 20px rgba(217, 119, 6, 0.3); }
    .rank-2 { background: var(--silver); box-shadow: 0 10px 20px rgba(71, 85, 105, 0.2); }
    .rank-3 { background: var(--bronze); box-shadow: 0 10px 20px rgba(154, 52, 18, 0.2); }
    .rank-other { background: #f1f5f9; color: #94a3b8; }

    .bar-bg { height: 10px; background: #f1f5f9; border-radius: 10px; overflow: hidden; }
    .bar-fill { height: 100%; border-radius: 10px; position: relative; transition: 1s cubic-bezier(0.34, 1.56, 0.64, 1); }
    .bar-fill::after {
        content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        animation: flow 2s infinite;
    }
    @keyframes flow { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

    /* è¿˜åŸå¼¹çª—æ‰€éœ€çš„æ ·å¼ */
    .modal-hero { padding: 40px 30px; color: white; text-align: center; position: relative; }
    .form-section { padding: 30px; background: white; }
    .input-modern {
        width: 100%; padding: 15px; border: 2px solid #f1f5f9; border-radius: 16px;
        outline: none; transition: 0.2s; font-size: 16px; font-weight: 600; color: #1e293b;
    }
    .label-premium { display: block; font-size: 14px; font-weight: 800; color: #64748b; margin-bottom: 10px; }
    .special-reward-card {
        background: #fff; border: 3px solid #f1f5f9; border-radius: 20px; padding: 20px;
        text-align: center; cursor: pointer; transition: all 0.3s;
    }
    .special-reward-card.selected { border-color: #be123c; background: #fff1f2; }
</style>

<!-- é¾™è™æ¦œä¸»é¡µå†…å®¹ -->
<div class="ranking-header">
    <div class="brand">
        <div class="brand-icon"><i class="fas fa-chess-king"></i></div>
        <div class="brand-text">
            <h2>è£èª‰é¾™è™æ¦œ</h2>
            <p>å®æ—¶ç«æŠ€çœ‹æ¿ Â· SEASON 2025</p>
        </div>
    </div>
    <div class="nav-actions">
        <button class="btn-glass" style="background:#10b981" onclick="openRewardManager('grocery')"><i class="fas fa-shopping-basket"></i> æ‚è´§é“º</button>
        <button class="btn-glass" style="background:#f59e0b" onclick="openRewardManager('regular')"><i class="fas fa-gem"></i> å¥–å“åº“</button>
        <button class="btn-glass" style="background:linear-gradient(135deg, #ef4444, #b91c1c)" onclick="openAuctionModal()"><i class="fas fa-gavel"></i> å¯åŠ¨æ‹å–</button>
        <button class="btn-glass" style="background:linear-gradient(135deg, #6366f1, #4338ca)" onclick="openBountyModal()"><i class="fas fa-bullhorn"></i> å‘å¸ƒæ‚¬èµ</button>
    </div>
</div>

<div id="bountySection" style="display:none; margin-bottom:40px;">
    <div class="section-head"><i class="fas fa-bolt" style="color:#f59e0b"></i> å®æ—¶æ‚¬èµä»»åŠ¡</div>
    <div id="bountyList" class="bounty-grid"></div>
</div>

<div class="main-grid">
    <div class="timeline-card glass-card">
        <div class="section-head" style="margin-left:0"><i class="fas fa-history" style="color:var(--primary)"></i> è£èª‰è¶³è¿¹</div>
        <div id="eventList" class="timeline-list"></div>
    </div>

    <div class="rank-card glass-card">
        <div class="rank-tabs">
            <div class="pill-group">
                <button id="tabStu" class="pill-btn active" onclick="switchTab('student')">ä¸ªäººè£èª‰æ¦œ</button>
                <button id="tabGrp" class="pill-btn" onclick="switchTab('group')">å°ç»„éœ¸æƒæ¦œ</button>
            </div>
            <div style="display:flex; gap:10px; align-items:center;">
                <input type="date" id="startD" class="input-modern" style="height:38px; width:130px; border-radius:12px; font-size:12px; padding:0 12px; border:1px solid #e2e8f0;">
                <span style="color:#cbd5e1; font-weight:900;">è‡³</span>
                <input type="date" id="endD" class="input-modern" style="height:38px; width:130px; border-radius:12px; font-size:12px; padding:0 12px; border:1px solid #e2e8f0;">
                <button onclick="fetchData()" style="background:var(--primary); color:white; border:none; padding:10px 18px; border-radius:12px; font-weight:800; cursor:pointer; font-size:13px;">ç­›é€‰</button>
            </div>
        </div>
        <div style="max-height:800px; overflow-y:auto;">
            <table class="data-table">
                <thead id="tableHead"></thead>
                <tbody id="rankBody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- ============ è¿˜åŸï¼šå¼¹çª—éƒ¨åˆ† ============ -->

<!-- å¼¹çª—ï¼šå‡†å¤‡æ‹å– -->
<div id="auctionPrepModal" class="modal">
    <div class="modal-content" style="max-width: 500px; border-radius: 30px; overflow: hidden; border: 3px solid #be123c; margin: 5vh auto;">
        <div class="modal-hero" style="background: linear-gradient(135deg, #be123c 0%, #4c0519 100%); padding: 30px 20px;">
            <h3 style="font-size: 24px; margin: 0; font-weight: 900;"><i class="fas fa-gavel"></i> å¯åŠ¨æ‹å–ç››å…¸</h3>
            <span class="close" onclick="closeModal('auctionPrepModal')" style="color:white; top:20px; right:20px;">&times;</span>
        </div>
        <div class="form-section">
            <label class="label-premium">1. æŒ‘é€‰æ‹å–çå“</label>
            <div id="specialRewardGrid" style="display:grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 25px; max-height: 200px; overflow-y: auto;"></div>
            <label class="label-premium">2. è®¾å®šèµ·æ‹åº•åˆ†</label>
            <div style="background: #f8fafc; padding: 15px; border-radius: 20px; border: 2px solid #e2e8f0; text-align: center;">
                <input type="number" id="prepPrice" value="10" style="font-size: 40px; font-weight: 950; text-align: center; color: #be123c; background: transparent; border: none; width: 100%; outline: none;">
            </div>
            <button class="btn-glass" style="width:100%; height:65px; background:#1e293b; color:white; justify-content:center; margin-top:25px; border-radius:20px; font-size: 20px;" onclick="executeStartAuction()">ç«‹å³å¼€å¯</button>
        </div>
    </div>
</div>

<!-- å¼¹çª—ï¼šå‘å¸ƒæ‚¬èµ -->
<div id="bountyModal" class="modal">
    <div class="modal-content" style="max-width: 750px; border-radius: 30px; overflow: hidden; border: 3px solid #3b82f6; margin: 2vh auto;">
        <div class="modal-hero" style="background: linear-gradient(135deg, #3b82f6 0%, #1e3a8a 100%); padding: 20px 30px; text-align: left;">
            <h3 style="font-size: 24px; margin: 0; color: white;"><i class="fas fa-bullhorn"></i> å‘å¸ƒå…¨ç­æ‚¬èµ</h3>
            <span class="close" onclick="closeModal('bountyModal')" style="color:white; top:20px; right:30px;">&times;</span>
        </div>
        <div class="form-section" style="display: grid; grid-template-columns: 300px 1fr; gap: 20px;">
            <div style="border-right: 1px solid #f1f5f9; padding-right: 20px;">
                <div style="display:flex; gap:10px; margin-bottom:15px; background: #f8fafc; padding: 10px; border-radius: 12px;">
                    <label><input type="radio" name="bt" value="individual" checked> ä¸ªäºº</label>
                    <label><input type="radio" name="bt" value="group"> å°ç»„</label>
                </div>
                <label class="label-premium">1. æŒ‘é€‰æ‚¬èµå¥–å“</label>
                <div id="bountyGrid" style="display:grid; grid-template-columns: 1fr 1fr; gap: 8px; max-height: 200px; overflow-y: auto; border: 1px solid #f1f5f9; border-radius: 10px; padding: 5px;"></div>
                <div id="selBountyHint" style="font-size: 12px; color: #64748b; text-align: center; margin-top:10px;">è¯·é€‰æ‹©å¥–å“</div>
            </div>
            <div>
                <label class="label-premium">2. åˆ¤å®šè§„åˆ™</label>
                <div id="bountyStandardTree" style="height: 160px; overflow-y: auto; background: #f8fafc; border-radius: 12px; padding: 12px; border: 1px solid #dbeafe;"></div>
                <label class="label-premium" style="margin-top:15px;">3. æœ‰æ•ˆå‘¨æœŸ</label>
                <div style="display:flex; align-items:center; gap:10px;">
                    <input type="date" id="bStart" class="input-modern" style="padding:5px;">
                    <span>è‡³</span>
                    <input type="date" id="bEnd" class="input-modern" style="padding:5px;">
                </div>
            </div>
        </div>
        <div style="padding: 20px; text-align:right;"><button class="btn-glass" style="background:#1e293b; width:200px; justify-content:center;" onclick="doBountySubmit()">å‘å¸ƒæ‚¬èµ</button></div>
    </div>
</div>

<!-- å¼¹çª—ï¼šä»“åº“ç®¡ç† -->
<div id="rewardManagerModal" class="modal">
    <div class="modal-content" style="max-width: 950px; height: 85vh; border-radius: 24px; overflow: hidden; margin: 3vh auto; border: none; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
        <div class="modal-hero" id="rmHeader" style="background: #1e293b; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center;">
            <h3 id="rmTitle" style="font-size: 22px; margin: 0; color: white; font-weight: 900; letter-spacing: 1px;">ç‰©èµ„ä»“åº“ç®¡ç†</h3>
            <div onclick="closeModal('rewardManagerModal')" style="width: 32px; height: 32px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s;">
                <i class="fas fa-times" style="color: white; font-size: 16px;"></i>
            </div>
        </div>
        <div style="display:flex; height: calc(85vh - 72px); background: #fff;">
            <!-- å·¦ä¾§è¡¨å• -->
            <div style="width:360px; padding:30px; border-right: 1px solid #f1f5f9; background: #fff; display: flex; flex-direction: column;">
                <form onsubmit="saveReward(event)" id="rewardForm" style="flex: 1;">
                    <input type="hidden" id="rmIsGrocery" name="is_grocery">
                    
                    <div style="margin-bottom: 20px;">
                        <label class="label-premium">å¥–å“åç§°</label>
                        <input type="text" id="rmName" name="name" class="input-modern" placeholder="è¾“å…¥å¥–å“åç§°" required 
                               style="background: #f8fafc; border: 1px solid #e2e8f0; padding: 12px 15px;">
                    </div>

                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom: 20px;">
                        <div>
                            <label class="label-premium">æ‰€éœ€ç§¯åˆ†</label>
                            <input type="number" id="rmPts" name="points_cost" class="input-modern" placeholder="0" required
                                   style="background: #f8fafc; border: 1px solid #e2e8f0; text-align: center;">
                        </div>
                        <div>
                            <label class="label-premium">å½“å‰åº“å­˜</label>
                            <input type="number" id="rmStock" name="stock" class="input-modern" placeholder="10" required
                                   style="background: #f8fafc; border: 1px solid #e2e8f0; text-align: center;">
                        </div>
                    </div>

                    <div id="specialBox" style="margin-bottom: 20px; background: #fff7ed; padding: 12px; border-radius: 12px; border: 1px solid #ffedd5;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; color: #9a3412; font-weight: 700; font-size: 13px;">
                            <input type="checkbox" id="rmSpecial" name="is_special" value="1" style="width: 16px; height: 16px; accent-color: #f97316;"> 
                            è®¾ä¸ºç‰¹æ®Šå¥–åŠ± (ç”¨äºæ‹å–/æ‚¬èµ)
                        </label>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label class="label-premium">ä¸Šä¼ å›¾ç‰‡</label>
                        <input type="file" id="rmImg" name="image" style="width: 100%; font-size: 12px; color: #64748b; background: #f8fafc; padding: 10px; border-radius: 12px; border: 1px dashed #cbd5e1;">
                    </div>

                    <button class="btn-glass" style="width:100%; height:50px; background: #1e293b; justify-content:center; font-size: 15px; margin-top: auto;">
                        <i class="fas fa-plus-circle"></i> ç¡®è®¤ä¸Šæ¶
                    </button>
                </form>
            </div>

            <!-- å³ä¾§åˆ—è¡¨ -->
            <div style="flex:1; background:#f8fafc; padding:30px; overflow-y:auto;" id="rmList"></div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let currentType = 'student', selSpecId = null, selBountyId = null, currentBountyPrice = 0;

document.addEventListener('DOMContentLoaded', () => { 
    fetchData(); loadBounties(); loadEvents(); 
    setInterval(() => { loadBounties(); loadEvents(); }, 30000); 
});

async function fetchData() {
    const s = document.getElementById('startD').value, e = document.getElementById('endD').value;
    let url = `/api/ranking?type=${currentType}`;
    if(s && e) url += `&start_date=${s}&end_date=${e}`;
    const res = await fetch(url); const data = await res.json(); renderTable(data);
}

function renderTable(data) {
    const head = document.getElementById('tableHead'), body = document.getElementById('rankBody'); 
    body.innerHTML = '';
    if(currentType === 'student') {
        head.innerHTML = `<tr><th width="100">æ’å</th><th>é€‰æ‰‹</th><th>æ‰€å±æˆ˜é˜Ÿ</th><th>èµ›å­£ç§¯åˆ†</th></tr>`;
        data.forEach((x, i) => {
            let badge = i < 3 ? `rank-${i+1}` : 'rank-other';
            let icon = i < 3 ? `<i class="fas fa-crown"></i>` : i+1;
            body.innerHTML += `
                <tr style="animation: fadeIn 0.5s ease forwards; animation-delay: ${i*0.05}s; opacity:0;">
                    <td><div class="rank-badge ${badge}">${icon}</div></td>
                    <td><div style="font-weight:900; font-size:16px;">${x.name}</div></td>
                    <td><span style="background:#f1f5f9; padding:4px 10px; border-radius:8px; font-size:11px; font-weight:800; color:#64748b;">${x.group_name||'è‡ªç”±äºº'}</span></td>
                    <td><span style="font-size:20px; font-weight:950; color:var(--primary);">${x.points}</span></td>
                </tr>`;
        });
    } else {
        head.innerHTML = `<tr><th width="100">æ’å</th><th>æˆ˜é˜Ÿ</th><th>èµ›å­£æ€»åˆ†</th></tr>`;
        data.forEach((x, i) => {
            let badge = i < 3 ? `rank-${i+1}` : 'rank-other';
            body.innerHTML += `
                <tr>
                    <td><div class="rank-badge ${badge}">${i+1}</div></td>
                    <td><div style="font-weight:900; font-size:16px;">${x.name}</div></td>
                    <td><span style="font-size:20px; font-weight:950; color:var(--primary);">${x.points}</span></td>
                </tr>`;
        });
    }
}

function switchTab(t) { 
    currentType = t; 
    document.getElementById('tabStu').classList.toggle('active', t==='student'); 
    document.getElementById('tabGrp').classList.toggle('active', t==='group'); 
    fetchData(); 
}

async function loadBounties() {
    const res = await fetch('/api/bounties/progress');
    const data = await res.json();
    const box = document.getElementById('bountySection');
    const list = document.getElementById('bountyList');
    if(data.length > 0) {
        box.style.display = 'block';
        list.innerHTML = data.map(b => {
            // å–ç¬¬ä¸€åä½œä¸ºé¢†è·‘è€…è¿›è¡Œç»“é¡¹
            const topLeader = b.leaders.length > 0 ? b.leaders[0] : { name: 'æš‚æ— ', points: 0, id: 0 };
            const isDone = topLeader.points >= b.target_points;
            const per = Math.min(100, (topLeader.points / b.target_points) * 100);
            const color = b.type === 'group' ? '#8b5cf6' : '#3b82f6';
            return `
                <div class="bounty-card-v2 glass-card">
                    <div class="bounty-type-tag" style="background:${color}">${b.type === 'group' ? 'æˆ˜é˜Ÿ' : 'ä¸ªäºº'}</div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                        <div style="font-size:20px;">ğŸ†</div>
                        <div style="text-align:right"><div style="font-size:14px; font-weight:900;">${topLeader.name}</div></div>
                    </div>
                    <div style="font-size:16px; font-weight:900; margin-bottom:10px;">${b.reward_name}</div>
                    <div class="bar-bg" style="margin-bottom:15px;"><div class="bar-fill" style="width:${per}%; background:${isDone?'#10b981':color}"></div></div>
                    <button onclick="${isDone?`finishBounty(${b.id}, ${topLeader.id}, '${topLeader.name}', ${b.target_points})`:''}" 
                            style="width:100%; padding:10px; border-radius:12px; border:none; cursor:${isDone?'pointer':'not-allowed'}; background:${isDone?'#10b981':'#f1f5f9'}; color:${isDone?'white':'#94a3b8'}; font-weight:800;">
                        ${isDone?'ç»“é¡¹é¢†å¥–':'ç«é€ä¸­ '+topLeader.points+'/'+b.target_points}
                    </button>
                </div>`;
        }).join('');
    } else box.style.display = 'none';
}

async function finishBounty(bid, leaderId, name, prize) {
    const preRes = await fetch('/api/bounty/preview_finish', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ bounty_id: bid, leader_id: leaderId })
    });
    const preData = await preRes.json();
    const confirmMsg = `ç¡®å®šä¸ºã€${name}ã€‘ç»“é¡¹å—ï¼Ÿ\n\n${preData.plan.map(p => `${p.name}: æ‰£é™¤ ${p.deduct}åˆ†`).join('\n')}\n\næ‰§è¡Œåå°†åŒæ­¥æ ¸å‡å¥–å“åº“å­˜ã€‚`;
    if(!confirm(confirmMsg)) return;
    const res = await fetch('/api/bounty/finish', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ bounty_id: bid, leader_id: leaderId, plan: preData.plan, reward_name: preData.reward_name })
    });
    if(res.ok) { loadBounties(); fetchData(); loadEvents(); }
}

async function loadEvents() {
    const res = await fetch('/api/events/recent');
    const data = await res.json();
    document.getElementById('eventList').innerHTML = data.map(e => {
        let color = e.type==='auction'?'#ef4444':(e.type==='bounty'?'#8b5cf6':'#10b981');
        return `
            <div class="event-item">
                <div class="event-icon" style="border-color:${color}"></div>
                <div style="font-size:13px; font-weight:800;"><span style="color:${color}">${e.winner_name}</span> è·å¾— ${e.reward_name}</div>
                <div style="font-size:11px; color:#94a3b8;">${e.time}</div>
            </div>`;
    }).join('') || '<div style="text-align:center; padding:40px 0; color:#cbd5e1; font-weight:800;">æš‚æ— æœ€æ–°åŠ¨æ€</div>';
}

function openRewardManager(type) {
    const isG = type==='grocery'?1:0; 
    document.getElementById('rmIsGrocery').value = isG;
    document.getElementById('rmTitle').innerText = isG ? 'æ‚è´§é“ºç®¡ç†' : 'å¥–å“åº“ç®¡ç†';
    document.getElementById('rmHeader').style.background = isG ? '#10b981' : '#f59e0b';
    document.getElementById('specialBox').style.display = isG ? 'none' : 'block';
    document.getElementById('rewardManagerModal').style.display = 'block';
    loadRMList();
}

async function loadRMList() {
    const isG = document.getElementById('rmIsGrocery').value;
    const res = await fetch(`/api/rewards?is_grocery=${isG}`); 
    const data = await res.json();
    document.getElementById('rmList').innerHTML = data.map(r => `
        <div style="background:white; padding:18px; border-radius:16px; margin-bottom:12px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 4px 6px -1px rgba(0,0,0,0.05); border:1px solid #f1f5f9;">
            <div style="display:flex; align-items:center; gap:15px;">
                <div style="width:56px; height:56px; border-radius:12px; background:#f8fafc; overflow:hidden; display:flex; align-items:center; justify-content:center; border:1px solid #e2e8f0;">
                    ${r.image_path ? `<img src="${r.image_path}" style="width:100%; height:100%; object-fit:cover;">` : '<i class="fas fa-gift" style="color:#cbd5e1; font-size:24px;"></i>'}
                </div>
                <div>
                    <div style="font-weight:900; font-size:15px; color:#1e293b; display:flex; align-items:center; gap:8px;">
                        ${r.name}
                        ${r.is_special ? '<span style="font-size:10px; background:#fff7ed; color:#ea580c; padding:2px 8px; border-radius:6px; border:1px solid #ffedd5;"><i class="fas fa-star"></i> ç‰¹æ®Š</span>' : ''}
                    </div>
                    <div style="font-size:12px; color:#64748b; margin-top:4px; font-weight:600;">
                        <span style="color:#6366f1;">${r.points_cost} ç§¯åˆ†</span> <span style="margin:0 5px; opacity:0.3;">|</span> åº“å­˜: ${r.stock}
                    </div>
                </div>
            </div>
            <button onclick="delR(${r.id})" style="border:none; background:transparent; color:#ef4444; padding:8px; border-radius:8px; cursor:pointer; opacity:0.6; transition:0.2s;" onmouseover="this.style.opacity=1;this.style.background='#fef2f2'"><i class="fas fa-trash-alt" style="font-size:16px;"></i></button>
        </div>`).join('') || '<div style="text-align:center; color:#94a3b8; padding:40px;">æš‚æ— ç‰©èµ„ï¼Œè¯·åœ¨å·¦ä¾§ä¸Šæ¶</div>';
}

async function saveReward(e) {
    e.preventDefault();
    const fd = new FormData(document.getElementById('rewardForm'));
    const imgFile = document.getElementById('rmImg').files[0];
    if(imgFile) fd.append('image', imgFile); // ç¡®ä¿å›¾ç‰‡æ–‡ä»¶è¢«æ­£ç¡®æ·»åŠ 
    
    await fetch('/api/rewards', { method:'POST', body:fd });
    document.getElementById('rewardForm').reset();
    loadRMList();
}

async function delR(id) { if(confirm('ç¡®å®šä¸‹æ¶ï¼Ÿ')){ await fetch(`/api/rewards/${id}`, {method:'DELETE'}); loadRMList(); } }

async function openBountyModal() {
    document.getElementById('bountyModal').style.display = 'block';
    const now = new Date();
    const weekLater = new Date();
    weekLater.setDate(now.getDate() + 7);
    document.getElementById('bStart').value = now.toISOString().split('T')[0];
    document.getElementById('bEnd').value = weekLater.toISOString().split('T')[0];
    const rRes = await fetch('/api/rewards?is_grocery=0'); 
    const specs = (await rRes.json()).filter(r => r.is_special === 1);
    document.getElementById('bountyGrid').innerHTML = specs.map(r => `
        <div onclick="selB(${r.id}, ${r.points_cost})" class="special-reward-card" id="bs-${r.id}" style="padding:10px;">
            <div style="width:100%; height:60px; margin-bottom:8px; display:flex; align-items:center; justify-content:center; background:#f8fafc; border-radius:8px; overflow:hidden;">
                ${r.image_path ? `<img src="${r.image_path}" style="width:100%; height:100%; object-fit:cover;">` : '<i class="fas fa-award" style="font-size:24px; color:#cbd5e1"></i>'}
            </div>
            <div style="font-size:12px; font-weight:900;">${r.name}</div>
        </div>`).join('');
    const sRes = await fetch('/api/point_standards?raw=true');
    const rawStds = await sRes.json();
    const groups = {};
    rawStds.forEach(s => { if(!groups[s.category]) groups[s.category] = []; groups[s.category].push(s); });
    document.getElementById('bountyStandardTree').innerHTML = Object.keys(groups).map(cat => `
        <div style="margin-bottom:10px;">
            <label style="font-weight:900; font-size:13px; color:var(--primary);"><input type="checkbox" onchange="toggleBCat('${cat}', this.checked)"> ${cat}</label>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px; padding-left:15px;">
                ${groups[cat].map(i => `<label style="font-size:11px;"><input type="checkbox" class="b-std-check" data-cat="${cat}" data-reason="[${i.area}/${i.category}] ${i.name}"> ${i.name}</label>`).join('')}
            </div>
        </div>`).join('');
}

function toggleBCat(cat, c) { document.querySelectorAll(`.b-std-check[data-cat="${cat}"]`).forEach(el => el.checked = c); }

function selB(id, price) { 
    selBountyId = id; currentBountyPrice = price; 
    document.querySelectorAll('#bountyGrid .special-reward-card').forEach(el => el.classList.remove('selected'));
    document.getElementById(`bs-${id}`).classList.add('selected');
    document.getElementById('selBountyHint').innerHTML = `è¾¾æˆéœ€ <b>${price}</b> åˆ†`;
}

async function doBountySubmit() {
    const reasons = Array.from(document.querySelectorAll('.b-std-check:checked')).map(el => el.dataset.reason);
    const data = { reward_id: selBountyId, target_points: currentBountyPrice, type: document.querySelector('input[name="bt"]:checked').value, start_date: document.getElementById('bStart').value, end_date: document.getElementById('bEnd').value, allowed_reasons: reasons.join(',') };
    await fetch('/api/bounty/start', { method:'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
    closeModal('bountyModal'); loadBounties();
}

function openAuctionModal() {
    document.getElementById('auctionPrepModal').style.display = 'block';
    fetch('/api/rewards?is_grocery=0').then(r => r.json()).then(data => {
        const specs = data.filter(r => r.is_special === 1);
        document.getElementById('specialRewardGrid').innerHTML = specs.map(r => `
            <div onclick="selA(${r.id},${r.points_cost})" class="special-reward-card" id="as-${r.id}" style="padding:10px;">
                <div style="width:100%; height:60px; margin-bottom:8px; display:flex; align-items:center; justify-content:center; background:#f8fafc; border-radius:8px; overflow:hidden;">
                    ${r.image_path ? `<img src="${r.image_path}" style="width:100%; height:100%; object-fit:cover;">` : '<i class="fas fa-gem" style="font-size:24px; color:#cbd5e1"></i>'}
                </div>
                <div style="font-size:12px; font-weight:900;">${r.name}</div>
            </div>`).join('');
    });
}

function selA(id, cost) { 
    selSpecId = id; 
    document.querySelectorAll('#specialRewardGrid div').forEach(el => el.classList.remove('selected'));
    document.getElementById(`as-${id}`).classList.add('selected');
    document.getElementById('prepPrice').value = cost; 
}

function executeStartAuction() {
    fetch('/api/auction/start', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ reward_id: selSpecId, start_price: parseInt(document.getElementById('prepPrice').value) }) }).then(() => window.location.href = '/auction');
}

function closeModal(id) { document.getElementById(id).style.display = 'none'; }
</script>

<style>
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
{% endblock %}