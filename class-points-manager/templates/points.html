{% extends "base.html" %}

{% block title %}极速积分台{% endblock %}

{% block content %}
<style>
    .points-container { display: grid; grid-template-columns: 260px 1fr; gap: 25px; margin-top: 10px; }
    
    /* 左侧小组导航 */
    .filter-panel { background: white; border-radius: 24px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); height: fit-content; position: sticky; top: 90px; }
    .filter-panel h3 { margin: 0 0 20px 0; font-size: 1.1rem; font-weight: 800; color: var(--text-main); }
    .group-nav { display: flex; flex-direction: column; gap: 10px; }
    .nav-item { 
        padding: 14px 18px; border-radius: 16px; border: 1px solid #f1f5f9; cursor: pointer; 
        display: flex; align-items: center; justify-content: space-between; transition: all 0.2s;
        background: white; color: #64748b; border-left: 4px solid transparent;
    }
    .nav-item:hover { background: #f8faff; border-color: var(--primary); }
    .nav-item.active { background: #f0f4ff; color: var(--primary); border-color: #e0e7ff; border-left: 5px solid var(--primary); }
    .nav-dot { width: 8px; height: 8px; border-radius: 50%; background: #cbd5e1; }
    .active .nav-dot { background: var(--primary) !important; transform: scale(1.2); }
    .active b { color: var(--primary) !important; font-weight: 900; }

    /* 右侧卡片墙 */
    .work-panel { display: flex; flex-direction: column; gap: 20px; }
    .search-bar { background: white; padding: 15px 25px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); display: flex; gap: 15px; align-items: center; }
    .search-box { position: relative; flex: 1; }
    .search-box i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #cbd5e1; }
    .search-box input { width: 100%; padding: 10px 15px 10px 40px; border: 2px solid #f1f5f9; border-radius: 12px; outline: none; transition: 0.2s; }
    .search-box input:focus { border-color: var(--primary); }

    .student-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
    .student-card { background: white; border-radius: 24px; padding: 20px; border: 1px solid #f1f5f9; position: relative; transition: all 0.3s; }
    .student-card:hover { transform: translateY(-5px); box-shadow: 0 12px 25px rgba(0,0,0,0.05); border-color: var(--primary); }
    .points-badge { position: absolute; top: 15px; right: 15px; font-weight: 900; font-size: 22px; color: var(--primary); background: #f0f4ff; padding: 4px 12px; border-radius: 10px; }
    .stu-name { font-weight: 800; font-size: 17px; margin-bottom: 5px; }
    .stu-id { font-size: 12px; color: #94a3b8; font-family: monospace; }

    .quick-btns { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 15px; }
    .q-btn { border: none; padding: 10px 0; border-radius: 10px; font-weight: 800; font-size: 14px; cursor: pointer; }
    .q-p1 { background: #f0fdf4; color: #10b981; }
    .q-p2 { background: #eff6ff; color: #3b82f6; }
    .q-m1 { background: #fef2f2; color: #ef4444; }
    .q-more { background: #f8fafc; color: #64748b; grid-column: span 3; font-size: 12px; border: 1px solid #edf2f7; }

    /* === 统一高级模态框 UI === */
    .premium-modal { border-radius: 35px !important; overflow: hidden; border: none !important; }
    .modal-hero { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); padding: 30px; color: white; text-align: center; position: relative; }
    .modal-hero h3 { margin: 0; font-size: 20px; font-weight: 900; }
    .modal-hero.batch { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
    
    .selector-card { background: #f8fafc; border-radius: 20px; padding: 20px; border: 1px solid #edf2f7; margin-bottom: 15px; }
    .selector-card label { display: block; font-size: 11px; font-weight: 900; color: #cbd5e1; text-transform: uppercase; margin-bottom: 8px; }
    
    .premium-input { width: 100%; border: 2px solid transparent; background: white; padding: 12px; border-radius: 14px; font-weight: 700; color: #1e293b; outline: none; transition: 0.2s; font-size: 14px; }
    .premium-input:focus { border-color: #6366f1; }

    .score-display { text-align: center; padding: 15px; background: white; border-radius: 18px; border: 2px solid #f1f5f9; display: flex; align-items: center; justify-content: center; gap: 10px; }
    .score-num { font-size: 32px; font-weight: 900; color: var(--primary); }
    .score-label { font-size: 12px; font-weight: 800; color: #94a3b8; text-align: left; }

    .btn-confirm { width: 100%; height: 55px; background: #1e293b; color: white; border: none; border-radius: 18px; font-size: 17px; font-weight: 900; cursor: pointer; transition: 0.3s; }
    .btn-confirm:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }

    .tab-box { display: flex; background: #f1f5f9; padding: 4px; border-radius: 12px; }
    .tab-btn { flex: 1; border: none; padding: 8px; border-radius: 9px; cursor: pointer; font-size: 12px; font-weight: 700; background: transparent; }
    .tab-btn.active { background: white; color: var(--primary); }
    
    .select-list { border: 2px solid #f1f5f9; border-radius: 16px; max-height: 180px; overflow-y: auto; padding: 10px; display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; background: white; }
    .list-item { 
        padding: 8px 5px; text-align: center; border-radius: 8px; 
        background: #f8fafc; font-size: 12px; font-weight: 600; cursor: pointer;
        display: flex; align-items: center; justify-content: center; /* 强力居中 */
        min-height: 32px;
    }
    .list-item.selected { background: #eef2ff; border: 1px solid #6366f1; color: #6366f1; }
</style>

<div class="points-container">
    <div class="filter-panel">
        <h3>全班分组</h3>
        <div id="groupNav" class="group-nav"></div>
    </div>

    <div class="work-panel">
        <div class="search-bar">
            <div class="search-box"><i class="fas fa-search"></i><input type="text" id="stuSearch" placeholder="搜索学生..." oninput="renderGrid()"></div>
            <button class="btn btn-warning" onclick="openBatchModal()" style="background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color:white; border:none; padding:10px 20px; border-radius:12px; font-weight:800; cursor:pointer;">
                <i class="fas fa-layer-group"></i> 批量变更
            </button>
            <div style="font-size: 13px; color: #94a3b8; font-weight: 700;">共 <span id="displayCount">0</span> 人</div>
        </div>
        <div id="studentGrid" class="student-grid"></div>
    </div>
</div>

<!-- 弹窗 A: 单人自定义变更 -->
<div id="standardPointsModal" class="modal">
    <div class="modal-content premium-modal" style="max-width: 450px;">
        <div class="modal-hero">
            <h3 id="modalTitle">积分变更中心</h3>
            <p id="targetStuName">正在录入</p>
            <span class="close" onclick="closeModal('standardPointsModal')" style="color:white; top:20px; right:20px; opacity:0.5;">&times;</span>
        </div>
        <div class="modal-body" style="padding: 25px; background: white;">
            <input type="hidden" id="targetId">
            <div class="selector-card">
                <label>选择业务标准</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <select id="areaSelect" class="premium-input" onchange="updateCats('areaSelect','catSelect','itemSelect','finalPts')"></select>
                    <select id="catSelect" class="premium-input" onchange="updateItems('areaSelect','catSelect','itemSelect','finalPts')"></select>
                </div>
                <select id="itemSelect" class="premium-input" onchange="applyStandardPts('itemSelect','finalPts','finalPtsDisplay')"></select>
            </div>
            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 15px; margin-bottom: 20px;">
                <div class="score-display"><div class="score-num" id="finalPtsDisplay">+0</div><input type="hidden" id="finalPts"></div>
                <textarea id="finalNote" class="premium-input" style="height: 70px; resize: none;" placeholder="备注说明..."></textarea>
            </div>
            <button class="btn-confirm" onclick="doStandardSubmit()">确认并同步档案</button>
        </div>
    </div>
</div>

<!-- 弹窗 B: 批量规则变更 -->
<div id="batchModal" class="modal">
    <div class="modal-content premium-modal" style="max-width: 600px;">
        <div class="modal-hero batch">
            <h3>批量积分同步</h3>
            <p>请选择业务标准及适用对象</p>
            <span class="close" onclick="closeModal('batchModal')" style="color:white; top:20px; right:20px; opacity:0.5;">&times;</span>
        </div>
        <div class="modal-body" style="padding: 25px; background: white;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <!-- 规则选择 -->
                <div>
                    <div class="selector-card">
                        <label>1. 业务标准</label>
                        <select id="bArea" class="premium-input" style="margin-bottom:8px;" onchange="updateCats('bArea','bCat','bItem','bPts')"></select>
                        <select id="bCat" class="premium-input" style="margin-bottom:8px;" onchange="updateItems('bArea','bCat','bItem','bPts')"></select>
                        <select id="bItem" class="premium-input" onchange="applyStandardPts('bItem','bPts','bPtsDisp')"></select>
                    </div>
                    <div class="score-display" style="margin-bottom:15px;"><div class="score-num" id="bPtsDisp">+0</div><input type="hidden" id="bPts"></div>
                    <input type="text" id="bNote" class="premium-input" placeholder="批量备注...">
                </div>
                <!-- 选人区 -->
                <div style="display:flex; flex-direction:column;">
                    <label style="font-size: 11px; font-weight: 900; color: #cbd5e1; margin-bottom: 8px;">2. 适用对象 (<span id="bCount">0</span>)</label>
                    <div class="tab-box" style="margin-bottom:10px;"><button id="btStu" class="tab-btn active" onclick="switchBTab('student')">选学生</button><button id="btGrp" class="tab-btn" onclick="switchBTab('group')">选小组</button></div>
                    <div id="bList" class="select-list" style="flex:1;"></div>
                </div>
            </div>
            <button class="btn-confirm" style="margin-top:20px; background:#d97706;" onclick="doBatchSubmit()">执行全员数据同步</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let students = [], groups = [], rawStandards = [], currentGroupId = null;
let bTab = 'student', bSelectedIds = new Set();

document.addEventListener('DOMContentLoaded', loadAllData);

async function loadAllData() {
    try {
        const [sRes, gRes, stdRes] = await Promise.all([fetch('/api/students'), fetch('/api/groups'), fetch('/api/point_standards')]);
        students = await sRes.json(); groups = await gRes.json(); rawStandards = await stdRes.json();
        renderNav(); renderGrid(); initStandardSelectors();
    } catch(e) { console.error(e); }
}

function renderNav() {
    const container = document.getElementById('groupNav');
    let html = `<div class="nav-item ${currentGroupId===null?'active':''}" onclick="setGroup(null)"><div style="display:flex;align-items:center;gap:10px;"><div class="nav-dot"></div><b>全班同学</b></div><span>${students.length}</span></div>`;
    html += groups.map(g => `<div class="nav-item ${currentGroupId===g.id?'active':''}" onclick="setGroup(${g.id})"><div style="display:flex;align-items:center;gap:10px;"><div class="nav-dot" style="background:${g.color}"></div><b>${g.name}</b></div><span>${g.student_count}</span></div>`).join('');
    container.innerHTML = html;
}

function renderGrid() {
    const container = document.getElementById('studentGrid');
    const kw = document.getElementById('stuSearch').value.toLowerCase();
    let data = students;
    if(currentGroupId !== null) data = data.filter(s => s.group_id === currentGroupId);
    if(kw) data = data.filter(s => s.name.toLowerCase().includes(kw) || s.student_id.includes(kw));
    document.getElementById('displayCount').innerText = data.length;
    container.innerHTML = data.map(s => `
        <div class="student-card">
            <div class="points-badge" id="pts-${s.id}">${s.points}</div>
            <div class="stu-name">${s.name}</div>
            <div class="stu-id">${s.student_id}</div>
            <div class="quick-btns">
                <button class="q-btn q-p1" onclick="updatePoints(${s.id}, 1, '[快捷] 快速评分')">+1</button>
                <button class="q-btn q-p2" onclick="updatePoints(${s.id}, 2, '[快捷] 快速评分')">+2</button>
                <button class="q-btn q-m1" onclick="updatePoints(${s.id}, -1, '[快捷] 快速评分')">-1</button>
                <button class="q-btn q-more" onclick="openStandardModal(${s.id}, '${s.name}')">自定义变更...</button>
            </div>
        </div>
    `).join('');
}

function setGroup(id) { currentGroupId = id; renderNav(); renderGrid(); }

async function updatePoints(id, amount, reason) {
    const el = document.getElementById(`pts-${id}`);
    const newVal = parseInt(el.innerText) + amount;
    el.innerText = newVal;
    el.style.transform = 'scale(1.2)'; setTimeout(() => el.style.transform = 'scale(1)', 200);
    await fetch(`/api/students/${id}/points`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({change_amount:amount, reason:reason}) });
    const s = students.find(x => x.id === id); if(s) s.points = newVal;
}

// --- 联动引擎 ---
function initStandardSelectors() {
    const areas = [...new Set(rawStandards.map(s => s.area))];
    const html = areas.map(a => `<option value="${a}">${a}</option>`).join('');
    document.getElementById('areaSelect').innerHTML = html;
    document.getElementById('bArea').innerHTML = html;
    updateCats('areaSelect','catSelect','itemSelect','finalPts');
    updateCats('bArea','bCat','bItem','bPts');
}

function updateCats(aId, cId, iId, pId) {
    const area = document.getElementById(aId).value;
    const cats = [...new Set(rawStandards.filter(s => s.area === area).map(s => s.category))];
    document.getElementById(cId).innerHTML = cats.map(c => `<option value="${c}">${c}</option>`).join('');
    updateItems(aId, cId, iId, pId);
}

function updateItems(aId, cId, iId, pId) {
    const area = document.getElementById(aId).value;
    const cat = document.getElementById(cId).value;
    const items = rawStandards.filter(s => s.area === area && s.category === cat);
    document.getElementById(iId).innerHTML = items.map(i => `<option value="${i.name}" data-pts="${i.default_points}">${i.name}</option>`).join('');
    const dispId = aId === 'areaSelect' ? 'finalPtsDisplay' : 'bPtsDisp';
    applyStandardPts(iId, pId, dispId);
}

function applyStandardPts(iId, pId, dId) {
    const opt = document.getElementById(iId).selectedOptions[0];
    if(opt) {
        const pts = opt.dataset.pts;
        document.getElementById(pId).value = pts;
        const disp = document.getElementById(dId);
        disp.innerText = (pts >= 0 ? '+' : '') + pts;
        disp.style.color = pts >= 0 ? '#10b981' : '#ef4444';
    }
}

// --- 弹窗与提交 ---
function openStandardModal(id, name) {
    document.getElementById('targetId').value = id;
    document.getElementById('targetStuName').innerText = `正在为 ${name} 录入变更`;
    document.getElementById('standardPointsModal').style.display = 'block';
}

async function doStandardSubmit() {
    const id = document.getElementById('targetId').value;
    const reason = `[${document.getElementById('areaSelect').value}/${document.getElementById('catSelect').value}] ${document.getElementById('itemSelect').value}`;
    const pts = parseInt(document.getElementById('finalPts').value);
    const note = document.getElementById('finalNote').value.trim();
    await updatePoints(id, pts, note ? `${reason} | ${note}` : reason);
    closeModal('standardPointsModal');
}

function openBatchModal() { 
    bSelectedIds.clear(); document.getElementById('batchModal').style.display='block'; 
    switchBTab('student'); 
}

function switchBTab(t) { 
    bTab = t; bSelectedIds.clear(); 
    document.getElementById('btStu').classList.toggle('active', t==='student');
    document.getElementById('btGrp').classList.toggle('active', t==='group');
    renderBList(); updateBCount();
}

function renderBList() {
    const container = document.getElementById('bList');
    const data = (bTab === 'student') ? students : groups;
    container.innerHTML = data.map(item => `<div class="list-item ${bSelectedIds.has(item.id)?'selected':''}" onclick="toggleBSelect(${item.id})">${item.name}</div>`).join('');
}

function toggleBSelect(id) { if(bSelectedIds.has(id)) bSelectedIds.delete(id); else bSelectedIds.add(id); renderBList(); updateBCount(); }
function updateBCount() { document.getElementById('bCount').innerText = bSelectedIds.size; }

async function doBatchSubmit() {
    if(bSelectedIds.size === 0) return alert('请选择对象');
    const ids = bTab === 'group' ? students.filter(s => bSelectedIds.has(s.group_id)).map(s => s.id) : Array.from(bSelectedIds);
    const reason = `[批量] [${document.getElementById('bArea').value}/${document.getElementById('bCat').value}] ${document.getElementById('bItem').value}`;
    const pts = parseInt(document.getElementById('bPts').value);
    const note = document.getElementById('bNote').value.trim();
    
    await fetch('/api/students/batch/points', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({student_ids:ids, change_amount:pts, reason: note ? `${reason} | ${note}` : reason}) });
    alert('批量变更成功！'); closeModal('batchModal'); loadAllData();
}

function closeModal(id) { document.getElementById(id).style.display = 'none'; }
</script>
{% endblock %}