{% extends "base.html" %}

{% block title %}ç§¯åˆ†ç®¡ç† - æé€Ÿç‰ˆ{% endblock %}

{% block content %}
<style>
    /* === é¡µé¢å¸ƒå±€ === */
    .page-container {
        max-width: 1400px;
        margin: 0 auto;
    }

    /* é¡¶éƒ¨æ§åˆ¶æ  */
    .top-bar {
        background: white;
        padding: 15px 20px;
        border-radius: 16px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 15px;
    }

    .class-select {
        padding: 10px 15px;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        color: #2d3748;
        min-width: 200px;
        background-color: #f8fafc;
        cursor: pointer;
    }
    
    .search-box {
        position: relative;
        flex: 1;
        max-width: 400px;
    }
    
    .search-box input {
        width: 100%;
        padding: 10px 15px 10px 40px;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        font-size: 15px;
        transition: all 0.2s;
    }
    
    .search-box input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        outline: none;
    }
    
    .search-box i {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: #a0aec0;
    }

    /* === å¡ç‰‡ç½‘æ ¼å¸ƒå±€ === */
    .student-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 20px;
    }

    /* å­¦ç”Ÿå¡ç‰‡è®¾è®¡ */
    .student-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.02);
        padding: 20px;
        transition: transform 0.2s, box-shadow 0.2s;
        border: 1px solid #f1f5f9;
        position: relative;
        overflow: hidden;
    }

    .student-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 15px rgba(0,0,0,0.05);
        border-color: #e2e8f0;
    }
    
    /* ç§¯åˆ†å¤§æ•°å­— */
    .points-badge {
        position: absolute;
        top: 15px;
        right: 15px;
        font-size: 24px;
        font-weight: 800;
        color: #2b6cb0;
        background: #ebf8ff;
        padding: 5px 15px;
        border-radius: 12px;
        min-width: 60px;
        text-align: center;
    }

    .student-info {
        margin-bottom: 20px;
    }

    .student-name {
        font-size: 18px;
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 4px;
    }

    .student-meta {
        font-size: 13px;
        color: #718096;
        display: flex;
        gap: 10px;
        align-items: center;
    }
    
    .group-tag {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
    }

    /* å¿«æ·æŒ‰é’®åŒº */
    .quick-actions {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 8px;
        margin-top: 15px;
    }

    .btn-quick {
        border: none;
        border-radius: 8px;
        padding: 8px 0;
        font-weight: 700;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.1s;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .btn-quick:active {
        transform: scale(0.95);
    }

    .btn-p1 { background: #f0fff4; color: #2f855a; border: 1px solid #c6f6d5; }
    .btn-p1:hover { background: #dcffe4; }

    .btn-p2 { background: #ebf8ff; color: #2b6cb0; border: 1px solid #bee3f8; }
    .btn-p2:hover { background: #bee3f8; }

    .btn-m1 { background: #fff5f5; color: #c53030; border: 1px solid #fed7d7; }
    .btn-m1:hover { background: #fed7d7; }
    
    .btn-more { background: #edf2f7; color: #4a5568; border: 1px solid #e2e8f0; grid-column: span 3; margin-top: 4px;}
    .btn-more:hover { background: #e2e8f0; }

    /* åŠ¨ç”»æ•ˆæœ */
    @keyframes pop {
        0% { transform: scale(1); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
    }
    
    .pop-anim {
        animation: pop 0.3s ease-out;
    }

    /* å“åº”å¼è°ƒæ•´ */
    @media (max-width: 768px) {
        .top-bar { 
            padding: 15px; 
            flex-direction: column !important; 
            align-items: stretch !important; 
            gap: 12px;
            width: 100% !important;
            box-sizing: border-box;
        }
        .class-select { width: 100% !important; min-width: 0 !important; }
        .search-box { max-width: none !important; width: 100% !important; }
        .search-box input { width: 100% !important; }
        
        .student-grid {
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)) !important;
            gap: 10px !important;
            padding: 0 5px;
        }
        .modal-content { width: 95% !important; padding: 15px !important; }
    }

    @media (max-width: 480px) {
        .student-grid {
            grid-template-columns: 1fr 1fr !important; /* å¼ºåˆ¶ä¸¤åˆ— */
        }
        .student-card { padding: 12px !important; }
        .student-name { font-size: 15px !important; }
        .points-badge { font-size: 18px !important; padding: 2px 8px !important; top: 8px !important; right: 8px !important; min-width: auto !important; }
        .btn-quick { padding: 5px 0 !important; font-size: 12px !important; }
    }
    
    /* å¿«é€Ÿæ‰“å¡æ¨¡æ€æ¡†æ ·å¼ (å¤ç”¨åŸæœ‰é£æ ¼ä½†ç®€åŒ–) */
    .modal-body-grid {
        display: grid;
        grid-template-columns: 260px 1fr;
        height: 500px;
        gap: 20px;
    }
    
    /* å¤ç”¨ä¹‹å‰çš„é€‰æ‹©å™¨æ ·å¼ */
    .selector-panel { border: 1px solid #e2e8f0; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; }
    .selector-content { flex: 1; overflow-y: auto; padding: 10px; }
    .select-item { display: flex; align-items: center; padding: 8px 10px; margin-bottom: 2px; cursor: pointer; border-radius: 6px; }
    .select-item:hover { background: #f7fafc; }
    
</style>

<div class="page-container">
    <!-- é¡¶éƒ¨å·¥å…·æ  -->
    <div class="top-bar">
        <div style="display: flex; gap: 15px; align-items: center; flex: 1;">
            <select id="classSelect" class="class-select" onchange="loadData()">
                <option value="">åŠ è½½ç­çº§...</option>
            </select>
            
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="æœç´¢å­¦ç”Ÿå§“å..." oninput="filterCards()">
            </div>
        </div>

        <div>
            <!-- å®¡æ ¸æŒ‰é’® -->
            <button class="btn" onclick="openAuditModal()" style="margin-right: 10px; background: white; border: 1px solid #e2e8f0; color: #4a5568; position: relative; border-radius: 10px; padding: 10px 15px; font-weight: 600;">
                <i class="fas fa-bell"></i> å®¡æ ¸
                <span id="auditBadge" style="display: none; position: absolute; top: -5px; right: -5px; background: #f56565; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; display: flex; align-items: center; justify-content: center; border: 2px solid white;">0</span>
            </button>

            <button class="btn btn-warning" onclick="openQuickCheckInModal()" 
                    style="padding: 10px 20px; font-weight: bold; background: #ed8936; color: white; border: none; border-radius: 10px; box-shadow: 0 4px 6px rgba(237, 137, 54, 0.2);">
                <i class="fas fa-bolt"></i> å¿«é€Ÿæ‰“å¡
            </button>
        </div>
    </div>

    <!-- å­¦ç”Ÿå¡ç‰‡ç½‘æ ¼ -->
    <div id="studentGrid" class="student-grid">
        <!-- å¡ç‰‡ç”± JS ç”Ÿæˆ -->
    </div>
</div>

<!-- å®¡æ ¸æ¨¡æ€æ¡† -->
<div id="auditModal" class="modal">
    <div class="modal-content" style="max-width: 650px; max-height: 85vh; overflow: hidden; display: flex; flex-direction: column; border-radius: 20px;">
        <div class="modal-header" style="border-bottom: 1px solid #f1f5f9; padding: 20px 25px; display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0; font-size: 1.3rem; color: #1e293b; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-clipboard-check" style="color: #6366f1;"></i> å¾…åŠå®¡æ‰¹
            </h2>
            <div style="display: flex; align-items: center; gap: 15px;">
                <label style="display: flex; align-items: center; gap: 5px; font-size: 14px; color: #64748b; cursor: pointer;">
                    <input type="checkbox" id="auditSelectAll" onchange="toggleAllAudits(this.checked)" style="width: 16px; height: 16px;"> å…¨é€‰
                </label>
                <span class="close" onclick="closeModal('auditModal')" style="position: static;">&times;</span>
            </div>
        </div>
        <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 0;">
            <div id="auditList" style="display: flex; flex-direction: column;">
                <!-- JS åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        <div id="auditFooter" style="padding: 15px 25px; border-top: 1px solid #f1f5f9; display: none; justify-content: flex-end; gap: 12px; background: #f8fafc;">
            <span id="auditSelectedHint" style="flex: 1; align-self: center; font-size: 13px; color: #64748b;">å·²é€‰æ‹© 0 é¡¹</span>
            <button onclick="batchProcessAudits('reject')" style="background: white; color: #ef4444; border: 1px solid #fee2e2; padding: 10px 20px; border-radius: 10px; font-weight: 600; cursor: pointer;">æ‰¹é‡æ‹’ç»</button>
            <button onclick="batchProcessAudits('approve')" style="background: #6366f1; color: white; border: none; padding: 10px 25px; border-radius: 10px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 10px rgba(99, 102, 241, 0.2);">ä¸€é”®é€šè¿‡å®¡æ‰¹</button>
        </div>
    </div>
</div>

<!-- è‡ªå®šä¹‰åˆ†æ•°æ¨¡æ€æ¡† -->
<div id="customScoreModal" class="modal">
    <div class="modal-content" style="max-width: 400px; border-radius: 16px;">
        <div class="modal-header" style="border-bottom: none; padding-bottom: 0;">
            <h2 style="font-size: 1.2rem; margin: 0; color: #2d3748;">
                <i class="fas fa-edit" style="color: #667eea; margin-right: 8px;"></i>
                ç»™ <span id="customStudentName" style="color: #667eea;"></span> åŠ /å‡åˆ†
            </h2>
            <span class="close" onclick="closeModal('customScoreModal')">&times;</span>
        </div>
        <div class="modal-body">
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-size: 14px; color: #718096; margin-bottom: 8px;">åˆ†æ•° (è´Ÿæ•°ä»£è¡¨å‡åˆ†)</label>
                <input type="number" id="customPoints" class="form-control" placeholder="ä¾‹å¦‚: 5 æˆ– -5" 
                       style="font-size: 18px; font-weight: bold; text-align: center; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; width: 100%; box-sizing: border-box;">
            </div>
            
            <div style="margin-bottom: 25px;">
                <label style="display: block; font-size: 14px; color: #718096; margin-bottom: 8px;">ç†ç”± (å¯é€‰)</label>
                <input type="text" id="customReason" class="form-control" placeholder="ä¾‹å¦‚: ååŠ©è€å¸ˆå·¥ä½œ" 
                       style="padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; width: 100%; box-sizing: border-box;">
            </div>
            
            <button onclick="submitCustomScore()" style="width: 100%; background: #667eea; color: white; border: none; padding: 12px; border-radius: 10px; font-weight: bold; font-size: 16px; cursor: pointer; transition: background 0.2s;">
                ç¡®è®¤æäº¤
            </button>
        </div>
    </div>
</div>

<!-- å¿«é€Ÿæ‰“å¡æ¨¡æ€æ¡† (ä¿ç•™åŠŸèƒ½ï¼Œä¼˜åŒ–æ ·å¼) -->
<div id="quickCheckInModal" class="modal">
    <div class="modal-content" style="max-width: 900px; width: 95%;">
        <div class="modal-header" style="background: linear-gradient(135deg, #f6ad55 0%, #ed8936 100%); color: white;">
            <h2 style="margin: 0; font-size: 1.2rem;"><i class="fas fa-bolt"></i> æ‰¹é‡å¿«é€Ÿæ‰“å¡</h2>
            <span class="close" onclick="closeModal('quickCheckInModal')" style="color: white; opacity: 0.8;">&times;</span>
        </div>
        <div class="modal-body modal-body-grid">
            <!-- å·¦ä¾§ï¼šäº‹ä»¶ç±»å‹ -->
            <div class="selector-panel">
                <div style="padding: 15px; background: #fffaf0; border-bottom: 1px solid #fbd38d; color: #c05621; font-weight: bold;">
                    1. é€‰æ‹©äº‹ä»¶
                </div>
                <div id="quickActionsList" style="padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px;">
                    <!-- JS ç”Ÿæˆ -->
                </div>
            </div>

            <!-- å³ä¾§ï¼šé€‰æ‹©å­¦ç”Ÿ/åˆ†ç»„ -->
            <div class="selector-panel">
                <div style="padding: 10px 15px; background: #fffaf0; border-bottom: 1px solid #fbd38d;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="font-weight: bold; color: #c05621;">2. ç¡®è®¤åå• (<span id="selectedCount">0</span>)</span>
                        <div style="display: flex; background: #feebc8; padding: 2px; border-radius: 8px;">
                            <button id="tab-student" class="btn-tab active" onclick="switchQuickTab('student')" style="border:none; padding:4px 12px; border-radius:6px; font-size:12px; cursor:pointer; font-weight:bold;">æŒ‰å­¦ç”Ÿ</button>
                            <button id="tab-group" class="btn-tab" onclick="switchQuickTab('group')" style="border:none; padding:4px 12px; border-radius:6px; font-size:12px; cursor:pointer; font-weight:bold; background:transparent; color:#c05621;">æŒ‰å°ç»„</button>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="quickSearchInput" placeholder="æœç´¢å§“å/å°ç»„..." oninput="renderSelectorList()" style="flex:1; padding:6px 10px; border:1px solid #fbd38d; border-radius:6px; font-size:13px;">
                        <button onclick="toggleSelectAll()" style="background: white; border: 1px solid #ed8936; color: #ed8936; padding: 2px 8px; border-radius: 6px; font-size: 12px; cursor: pointer; white-space: nowrap;">å…¨é€‰/åé€‰</button>
                    </div>
                </div>
                <div id="studentSelectorList" class="selector-content">
                    <!-- JS ç”Ÿæˆ -->
                </div>
                
                <div style="padding: 15px; border-top: 1px solid #e2e8f0; display: flex; align-items: center; gap: 15px; background: #fffaf0;">
                    <div id="batchCustomInputArea" style="display: flex; flex: 1; gap: 10px; align-items: center;">
                        <input type="number" id="batchCustomPoints" placeholder="åˆ†å€¼" style="width: 90px; padding: 10px; border: 2px solid #e2e8f0; border-radius: 10px; text-align: center; font-weight: bold; background: white; outline: none;">
                        <input type="text" id="batchCustomReason" placeholder="è¯·è¾“å…¥ç†ç”±..." style="flex: 1; padding: 10px; border: 1px solid #e2e8f0; border-radius: 10px; background: white; outline: none;">
                    </div>
                    <button class="btn" onclick="submitBatch()" style="background: #ed8936; color: white; padding: 12px 30px; border: none; border-radius: 12px; font-weight: bold; white-space: nowrap; box-shadow: 0 4px 6px rgba(237, 137, 54, 0.2); cursor: pointer;">
                        ç¡®è®¤æäº¤
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // === å…¨å±€çŠ¶æ€ ===
    let allStudents = [];
    let allGroups = [];
    let currentClassId = null;
    let selectedStudentIds = new Set();
    let quickTab = 'student'; // 'student' or 'group'

    
        // === é¢„è®¾æ‰“å¡äº‹ä»¶ ===
    
        const QUICK_EVENTS = [
    
            { id: 'good_hw', name: 'ä½œä¸šä¼˜ç§€', points: 2, icon: 'ğŸ“š' },
    
            { id: 'active', name: 'ç§¯æå›ç­”', points: 1, icon: 'ğŸ™‹' },
    
            { id: 'discipline', name: 'çºªå¾‹æ ‡å…µ', points: 1, icon: 'ğŸ¤' },
    
            { id: 'cleaning', name: 'å«ç”Ÿè´Ÿè´£', points: 2, icon: 'ğŸ§¹' },
    
            { id: 'progress', name: 'è¿›æ­¥æ˜æ˜¾', points: 2, icon: 'ğŸ“ˆ' },
    
            { id: 'late', name: 'è¿Ÿåˆ°', points: -2, icon: 'â°' },
    
            { id: 'chat', name: 'é—²èŠ/èµ°ç¥', points: -1, icon: 'ğŸ¤«' },
    
            { id: 'no_hw', name: 'æœªäº¤ä½œä¸š', points: -2, icon: 'âŒ' },
    
            { id: 'custom', name: 'è‡ªå®šä¹‰', points: 0, icon: 'âœ¨' }
    
        ];
    
        let currentEvent = QUICK_EVENTS[0];
    
    
    
        // === åˆå§‹åŒ– ===
    
        document.addEventListener('DOMContentLoaded', () => {
    
            loadClasses();
    
        });
    
    
    
        async function loadClasses() {
    
            try {
    
                const res = await fetch('/api/classes');
    
                const classes = await res.json();
    
                const select = document.getElementById('classSelect');
    
                select.innerHTML = '';
    
                
    
                if (classes.length === 0) {
    
                    select.innerHTML = '<option value="">è¯·å…ˆåˆ›å»ºç­çº§</option>';
    
                    return;
    
                }
    
    
    
                classes.forEach(c => {
    
                    select.innerHTML += `<option value="${c.id}">${c.name}</option>`;
    
                });
    
                
    
                // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ª
    
                currentClassId = classes[0].id;
    
                loadData();
    
            } catch (e) {
    
                console.error(e);
    
            }
    
        }
    
    
    
            async function loadData() {
    
    
    
                currentClassId = document.getElementById('classSelect').value;
    
    
    
                if (!currentClassId) return;
    
    
    
        
    
    
    
                try {
    
    
    
                    const [sRes, gRes] = await Promise.all([
    
    
    
                        fetch(`/api/classes/${currentClassId}/students`),
    
    
    
                        fetch(`/api/groups?class_id=${currentClassId}`)
    
    
    
                    ]);
    
    
    
                    allStudents = await sRes.json();
    
    
    
                    allGroups = await gRes.json();
    
    
    
                    renderGrid();
    
    
    
                } catch (e) {
    
    
    
                    console.error("åŠ è½½æ•°æ®å¤±è´¥", e);
    
    
    
                }
    
    
    
            }
    
    
    
        
    
    
    
            // === å¿«é€Ÿæ‰“å¡ Tab åˆ‡æ¢ ===
    
    
    
            function switchQuickTab(tab) {
    
    
    
                quickTab = tab;
    
    
    
                const sTab = document.getElementById('tab-student');
    
    
    
                const gTab = document.getElementById('tab-group');
    
    
    
                
    
    
    
                if (tab === 'student') {
    
    
    
                    sTab.classList.add('active');
    
    
    
                    sTab.style.background = 'white';
    
    
    
                    gTab.classList.remove('active');
    
    
    
                    gTab.style.background = 'transparent';
    
    
    
                } else {
    
    
    
                    gTab.classList.add('active');
    
    
    
                    gTab.style.background = 'white';
    
    
    
                    sTab.classList.remove('active');
    
    
    
                    sTab.style.background = 'transparent';
    
    
    
                }
    
    
    
                renderSelectorList();
    
    
    
            }
    
    
    
        
    
    
    
            // === æ ¸å¿ƒï¼šæ¸²æŸ“æç®€å¡ç‰‡ ===
    
    
    
            function renderGrid() {
    
    
    
                const grid = document.getElementById('studentGrid');
    
    
    
                const term = document.getElementById('searchInput').value.toLowerCase();
    
    
    
                
    
    
    
                grid.innerHTML = '';
    
    
    
                
    
    
    
                allStudents.forEach(s => {
    
    
    
                    // æœç´¢è¿‡æ»¤
    
    
    
                    if (!s.name.toLowerCase().includes(term) && !s.student_id.toLowerCase().includes(term)) {
    
    
    
                        return;
    
    
    
                    }
    
    
    
        
    
    
    
                    const card = document.createElement('div');
    
    
    
                    card.className = 'student-card';
    
    
    
                    card.id = `card-${s.id}`;
    
    
    
                    
    
    
    
                    // åŠ¨æ€é¢œè‰²ï¼šæ ¹æ®åˆ†å€¼å˜è‰²
    
    
    
                    let badgeColor = '#ebf8ff'; // è“
    
    
    
                    let textColor = '#2b6cb0';
    
    
    
                    if (s.points < 0) { badgeColor = '#fff5f5'; textColor = '#c53030'; } // çº¢
    
    
    
                    if (s.points > 50) { badgeColor = '#f0fff4'; textColor = '#2f855a'; } // ç»¿
    
    
    
                    
    
    
    
                    card.innerHTML = `
    
    
    
                        <div class="points-badge" id="points-${s.id}" style="background:${badgeColor}; color:${textColor}">
    
    
    
                            ${s.points}
    
    
    
                        </div>
    
    
    
                        
    
    
    
                        <div class="student-info">
    
    
    
                            <div class="student-name">${s.name}</div>
    
    
    
                            <div class="student-meta">
    
    
    
                                <span>${s.student_id}</span>
    
    
    
                                ${s.group_name ? `<span style="display:flex;align-items:center;gap:4px;"><span class="group-tag" style="background:${s.group_color}"></span>${s.group_name}</span>` : ''}
    
    
    
                            </div>
    
    
    
                        </div>
    
    
    
                        
    
    
    
                        <div class="quick-actions">
    
    
    
                            <button class="btn-quick btn-p1" onclick="quickUpdate(${s.id}, 1, 'å¿«æ·è°ƒæ•´')">
    
    
    
                                +1
    
    
    
                            </button>
    
    
    
                            <button class="btn-quick btn-p2" onclick="quickUpdate(${s.id}, 2, 'å¿«æ·è°ƒæ•´')">
    
    
    
                                +2
    
    
    
                            </button>
    
    
    
                            <button class="btn-quick btn-m1" onclick="quickUpdate(${s.id}, -1, 'å¿«æ·è°ƒæ•´')">
    
    
    
                                -1
    
    
    
                            </button>
    
    
    
                            <button class="btn-quick btn-more" onclick="openCustomModal(${s.id}, '${s.name}')">
    
    
    
                                ...
    
    
    
                            </button>
    
    
    
                        </div>
    
    
    
                    `;
    
    
    
                    grid.appendChild(card);
    
    
    
                });
    
    
    
            }
    
    
    
        
    
    
    
            function filterCards() {
    
    
    
                renderGrid();
    
    
    
            }
    
    
    
        
    
    
    
            // === æé€Ÿæ›´æ–° (æ— å¼¹çª—) ===
    
    
    
            async function quickUpdate(studentId, amount, reason) {
    
    
    
                // 1. ä¹è§‚ UI æ›´æ–°ï¼šå…ˆæ”¹ç•Œé¢ï¼Œå†å‘è¯·æ±‚ï¼Œè®©ç”¨æˆ·æ„Ÿè§‰â€œç§’å¼€â€
    
    
    
                const pointsEl = document.getElementById(`points-${studentId}`);
    
    
    
                const currentPoints = parseInt(pointsEl.innerText);
    
    
    
                const newPoints = currentPoints + amount;
    
    
    
                
    
    
    
                pointsEl.innerText = newPoints;
    
    
    
                pointsEl.classList.remove('pop-anim');
    
    
    
                void pointsEl.offsetWidth; // è§¦å‘é‡ç»˜
    
    
    
                pointsEl.classList.add('pop-anim'); // æ’­æ”¾åŠ¨ç”»
    
    
    
                
    
    
    
                // é¢œè‰²æ›´æ–°é€»è¾‘
    
    
    
                if (newPoints < 0) { pointsEl.style.color = '#c53030'; pointsEl.style.background = '#fff5f5'; }
    
    
    
                else if (newPoints > 50) { pointsEl.style.color = '#2f855a'; pointsEl.style.background = '#f0fff4'; }
    
    
    
                else { pointsEl.style.color = '#2b6cb0'; pointsEl.style.background = '#ebf8ff'; }
    
    
    
        
    
    
    
                // 2. åå°å‘é€è¯·æ±‚
    
    
    
                try {
    
    
    
                    const res = await fetch(`/api/students/${studentId}/points`, {
    
    
    
                        method: 'POST',
    
    
    
                        headers: {'Content-Type': 'application/json'},
    
    
    
                        body: JSON.stringify({
    
    
    
                            change_amount: amount,
    
    
    
                            reason: reason,
    
    
    
                            teacher: 'æé€Ÿæ“ä½œ'
    
    
    
                        })
    
    
    
                    });
    
    
    
                    
    
    
    
                    if (!res.ok) {
    
    
    
                        // å¦‚æœå¤±è´¥ï¼Œå›æ»š UI (è™½ç„¶æ¦‚ç‡å¾ˆä½)
    
    
    
                        pointsEl.innerText = currentPoints;
    
    
    
                        alert('æ“ä½œå¤±è´¥ï¼Œæ•°æ®å·²å›æ»š');
    
    
    
                    } else {
    
    
    
                        // æ›´æ–°å†…å­˜ä¸­çš„æ•°æ®ï¼Œé˜²æ­¢åç»­æ¸²æŸ“é”™è¯¯
    
    
    
                        const student = allStudents.find(s => s.id === studentId);
    
    
    
                        if(student) student.points = newPoints;
    
    
    
                    }
    
    
    
                } catch (e) {
    
    
    
                    console.error(e);
    
    
    
                    pointsEl.innerText = currentPoints; // å›æ»š
    
    
    
                }
    
    
    
            }
    
    
    
            
    
    
    
            // === è‡ªå®šä¹‰åˆ†æ•°æ¨¡æ€æ¡†é€»è¾‘ (å•äºº) ===
    
    
    
            let customTargetId = null;
    
    
    
            
    
    
    
            function openCustomModal(studentId, studentName) {
    
    
    
                customTargetId = studentId;
    
    
    
                document.getElementById('customStudentName').innerText = studentName;
    
    
    
                document.getElementById('customPoints').value = '';
    
    
    
                document.getElementById('customReason').value = '';
    
    
    
                document.getElementById('customScoreModal').style.display = 'block';
    
    
    
                document.getElementById('customPoints').focus();
    
    
    
            }
    
    
    
            
    
    
    
            async function submitCustomScore() {
    
    
    
                if (!customTargetId) return;
    
    
    
                
    
    
    
                const points = parseInt(document.getElementById('customPoints').value);
    
    
    
                const reason = document.getElementById('customReason').value.trim() || 'è‡ªå®šä¹‰è°ƒæ•´';
    
    
    
                
    
    
    
                if (isNaN(points) || points === 0) {
    
    
    
                    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„åˆ†æ•°ï¼ˆæ­£æ•°æˆ–è´Ÿæ•°ï¼‰');
    
    
    
                    return;
    
    
    
                }
    
    
    
                
    
    
    
                closeModal('customScoreModal');
    
    
    
                // å¤ç”¨ quickUpdate çš„é€»è¾‘ï¼Œäº«å—ä¹è§‚ UI æ›´æ–°
    
    
    
                await quickUpdate(customTargetId, points, reason);
    
    
    
            }
    
    
    
        
    
    
    
            // === æ‰¹é‡æ¨¡æ€æ¡†é€»è¾‘ ===
    
    
    
            function openQuickCheckInModal() {
    
    
    
                document.getElementById('quickCheckInModal').style.display = 'block';
    
    
    
                currentEvent = QUICK_EVENTS[0]; // é‡ç½®ä¸ºç¬¬ä¸€ä¸ª
    
    
    
                renderEventList();
    
    
    
                selectedStudentIds.clear(); // æ¯æ¬¡æ‰“å¼€æ¸…ç©ºé€‰æ‹©
    
    
    
                switchQuickTab('student'); // é»˜è®¤åˆ‡åˆ°å­¦ç”Ÿ
    
    
    
                document.getElementById('quickSearchInput').value = '';
    
    
    
                
    
    
    
                // åˆå§‹åŒ–è¾“å…¥æ¡†æ•°æ®
    
    
    
                fillInputFromEvent(currentEvent);
    
    
    
            }
    
    
    
            
    
    
    
            // è¾…åŠ©å‡½æ•°ï¼šæŠŠäº‹ä»¶çš„æ•°æ®å¡«å…¥è¾“å…¥æ¡†
    
    
    
            function fillInputFromEvent(evt) {
    
    
    
                const pointsInput = document.getElementById('batchCustomPoints');
    
    
    
                const reasonInput = document.getElementById('batchCustomReason');
    
    
    
                
    
    
    
                if (evt.id === 'custom') {
    
    
    
                    pointsInput.value = ''; // è‡ªå®šä¹‰ç•™ç©ºè®©ç”¨æˆ·å¡«
    
    
    
                    reasonInput.value = '';
    
    
    
                    pointsInput.placeholder = 'åˆ†å€¼';
    
    
    
                    reasonInput.placeholder = 'è¯·è¾“å…¥ç†ç”±...';
    
    
    
                    pointsInput.focus();
    
    
    
                } else {
    
    
    
                    pointsInput.value = evt.points;
    
    
    
                    reasonInput.value = evt.name;
    
    
    
                }
    
    
    
            }
    
    
    
        
    
    
    
            function renderEventList() {
    
    
    
                const container = document.getElementById('quickActionsList');
    
    
    
                container.innerHTML = '';
    
    
    
                
    
    
    
                QUICK_EVENTS.forEach(evt => {
    
    
    
                    const div = document.createElement('div');
    
    
    
                    const isSelected = currentEvent.id === evt.id;
    
    
    
                    div.style.cssText = `
    
    
    
                        padding: 10px; border: 1px solid ${isSelected ? '#ed8936' : '#e2e8f0'};
    
    
    
                        border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px;
    
    
    
                        background: ${isSelected ? '#fffaf0' : 'white'};
    
    
    
                    `;
    
    
    
                    div.onclick = () => { 
    
    
    
                        currentEvent = evt; 
    
    
    
                        renderEventList(); 
    
    
    
                        // å…³é”®ä¿®æ”¹ï¼šç‚¹å‡»å·¦ä¾§ï¼Œè‡ªåŠ¨å¡«å……å³ä¾§è¾“å…¥æ¡†
    
    
    
                        fillInputFromEvent(evt);
    
    
    
                    };
    
    
    
                    
    
    
    
                    let pointText = '';
    
    
    
                    let color = '#718096';
    
    
    
                    if (evt.id === 'custom') {
    
    
    
                        pointText = 'æ‰‹åŠ¨è¾“å…¥';
    
    
    
                    } else {
    
    
    
                        color = evt.points > 0 ? '#48bb78' : '#f56565';
    
    
    
                        pointText = (evt.points > 0 ? '+' : '') + evt.points;
    
    
    
                    }
    
    
    
        
    
    
    
                    div.innerHTML = `
    
    
    
                        <span style="font-size: 20px;">${evt.icon}</span>
    
    
    
                        <div style="flex: 1;">
    
    
    
                            <div style="font-weight: bold; color: #2d3748;">${evt.name}</div>
    
    
    
                            <div style="font-size: 12px; color: ${color}; font-weight: bold;">
    
    
    
                                ${pointText}
    
    
    
                            </div>
    
    
    
                        </div>
    
    
    
                        ${isSelected ? '<i class="fas fa-check-circle" style="color: #ed8936;"></i>' : ''}
    
    
    
                    `;
    
    
    
                    container.appendChild(div);
    
    
    
                });
    
    
    
            }
    
    
    
        
    
    
    
            function renderSelectorList() {
    
    
    
                const container = document.getElementById('studentSelectorList');
    
    
    
                const term = document.getElementById('quickSearchInput').value.toLowerCase();
    
    
    
                container.innerHTML = '';
    
    
    
                
    
    
    
                if (quickTab === 'student') {
    
    
    
                    allStudents.forEach(s => {
    
    
    
                        if (!s.name.toLowerCase().includes(term) && !s.student_id.toLowerCase().includes(term)) return;
    
    
    
                        
    
    
    
                        const div = document.createElement('div');
    
    
    
                        div.className = 'select-item';
    
    
    
                        const isSelected = selectedStudentIds.has(s.id);
    
    
    
                        div.innerHTML = `
    
    
    
                            <input type="checkbox" ${isSelected ? 'checked' : ''} style="margin-right: 10px; pointer-events: none;">
    
    
    
                            <div>${s.name} <small style="color:#a0aec0">(${s.student_id})</small></div>
    
    
    
                        `;
    
    
    
                        div.onclick = () => {
    
    
    
                            if (selectedStudentIds.has(s.id)) selectedStudentIds.delete(s.id);
    
    
    
                            else selectedStudentIds.add(s.id);
    
    
    
                            renderSelectorList(); 
    
    
    
                            document.getElementById('selectedCount').innerText = selectedStudentIds.size;
    
    
    
                        };
    
    
    
                        container.appendChild(div);
    
    
    
                    });
    
    
    
                } else {
    
    
    
                    // æŒ‰å°ç»„æ¸²æŸ“
    
    
    
                    allGroups.forEach(g => {
    
    
    
                        if (!g.name.toLowerCase().includes(term)) return;
    
    
    
                        
    
    
    
                        const groupStudents = allStudents.filter(s => s.group_id === g.id);
    
    
    
                        const isAllSelected = groupStudents.length > 0 && groupStudents.every(s => selectedStudentIds.has(s.id));
    
    
    
                        const isSomeSelected = !isAllSelected && groupStudents.some(s => selectedStudentIds.has(s.id));
    
    
    
        
    
    
    
                        const div = document.createElement('div');
    
    
    
                        div.className = 'select-item';
    
    
    
                        div.style.borderLeft = `4px solid ${g.color}`;
    
    
    
                        div.innerHTML = `
    
    
    
                            <input type="checkbox" ${isAllSelected ? 'checked' : ''} ${isSomeSelected ? 'style="opacity:0.6"' : ''} style="margin-right: 10px; pointer-events: none;">
    
    
    
                            <div style="flex:1"><strong>${g.name}</strong> <small style="color:#a0aec0">(${groupStudents.length}äºº)</small></div>
    
    
    
                        `;
    
    
    
                        div.onclick = () => {
    
    
    
                            if (isAllSelected) {
    
    
    
                                groupStudents.forEach(s => selectedStudentIds.delete(s.id));
    
    
    
                            } else {
    
    
    
                                groupStudents.forEach(s => selectedStudentIds.add(s.id));
    
    
    
                            }
    
    
    
                            renderSelectorList();
    
    
    
                            document.getElementById('selectedCount').innerText = selectedStudentIds.size;
    
    
    
                        };
    
    
    
                        container.appendChild(div);
    
    
    
                    });
    
    
    
                }
    
    
    
            }
    
    
    
        
    
    
    
            function toggleSelectAll() {
    
    
    
                const term = document.getElementById('quickSearchInput').value.toLowerCase();
    
    
    
                let currentPool = [];
    
    
    
                
    
    
    
                if (quickTab === 'student') {
    
    
    
                    currentPool = allStudents.filter(s => s.name.toLowerCase().includes(term) || s.student_id.toLowerCase().includes(term));
    
    
    
                } else {
    
    
    
                    const visibleGroups = allGroups.filter(g => g.name.toLowerCase().includes(term));
    
    
    
                    visibleGroups.forEach(g => {
    
    
    
                        currentPool.push(...allStudents.filter(s => s.group_id === g.id));
    
    
    
                    });
    
    
    
                }
    
    
    
        
    
    
    
                const allSelected = currentPool.every(s => selectedStudentIds.has(s.id));
    
    
    
                if (allSelected) {
    
    
    
                    currentPool.forEach(s => selectedStudentIds.delete(s.id));
    
    
    
                } else {
    
    
    
                    currentPool.forEach(s => selectedStudentIds.add(s.id));
    
    
    
                }
    
    
    
                
    
    
    
                renderSelectorList();
    
    
    
                document.getElementById('selectedCount').innerText = selectedStudentIds.size;
    
    
    
            }

    function closeModal(id) {
        document.getElementById(id).style.display = 'none';
    }

    async function submitBatch() {
        const ids = Array.from(selectedStudentIds);
        if (ids.length === 0) return alert('è¯·é€‰æ‹©å­¦ç”Ÿ');

        // å…³é”®ä¿®æ”¹ï¼šç»Ÿä¸€ä»è¾“å…¥æ¡†è·å–æ•°æ®ï¼Œä¸å†ä¾èµ– currentEvent çš„é¢„è®¾å€¼
        const points = parseInt(document.getElementById('batchCustomPoints').value);
        let reason = document.getElementById('batchCustomReason').value.trim();

        if (isNaN(points) || points === 0) {
            return alert('è¯·è¾“å…¥æœ‰æ•ˆçš„åˆ†æ•°');
        }
        if (!reason) {
            reason = 'æ‰¹é‡æ‰“å¡'; // é»˜è®¤ç†ç”±
        }

        try {
            const res = await fetch('/api/students/batch/points', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    student_ids: ids,
                    change_amount: points,
                    reason: reason,
                    teacher: 'æ‰¹é‡æ‰“å¡'
                })
            });
            
            if (res.ok) {
                alert('æ‰¹é‡å¤„ç†å®Œæˆï¼');
                closeModal('quickCheckInModal');
                loadData(); // åˆ·æ–°ä¸»ç½‘æ ¼
            } else {
                alert('å¤„ç†å¤±è´¥');
            }
        } catch (e) {
            console.error(e);
            alert('ç½‘ç»œé”™è¯¯');
        }
    }
    
    

    // å…³é—­æ¨¡æ€æ¡†ç‚¹å‡»å¤–éƒ¨
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = "none";
        }
    }

    // === å®¡æ ¸ç³»ç»Ÿé€»è¾‘ ===
    setInterval(checkPendingAudits, 10000); // æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡
    checkPendingAudits(); // åˆå§‹åŒ–æ£€æŸ¥

    async function checkPendingAudits() {
        try {
            const res = await fetch('/api/audit/pending');
            const list = await res.json();
            const badge = document.getElementById('auditBadge');
            if (list.length > 0) {
                badge.style.display = 'flex';
                badge.textContent = list.length;
            } else {
                badge.style.display = 'none';
            }
            return list;
        } catch(e) { console.error(e); return []; }
    }

    async function openAuditModal() {
        const list = await checkPendingAudits();
        const container = document.getElementById('auditList');
        const footer = document.getElementById('auditFooter');
        const selectAll = document.getElementById('auditSelectAll');
        
        container.innerHTML = '';
        selectAll.checked = false;
        footer.style.display = 'none';
        
        if (list.length === 0) {
            container.innerHTML = '<div style="padding:60px; text-align:center; color:#cbd5e0;"><i class="fas fa-check-circle" style="font-size:40px; margin-bottom:15px; display:block; opacity:0.5;"></i>å¤ªæ£’äº†ï¼Œæ‰€æœ‰ç”³è¯·éƒ½å¤„ç†å®Œå•¦ï¼</div>';
        } else {
            footer.style.display = 'flex';
            list.forEach(item => {
                const div = document.createElement('div');
                div.style.cssText = 'padding: 18px 25px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 15px; transition: background 0.2s;';
                div.onmouseover = () => div.style.background = '#fcfcfc';
                div.onmouseout = () => div.style.background = 'transparent';
                
                const pointsColor = item.change_amount > 0 ? '#10b981' : '#ef4444';
                const sign = item.change_amount > 0 ? '+' : '';
                
                div.innerHTML = `
                    <input type="checkbox" class="audit-item-check" data-id="${item.id}" onchange="updateAuditSelection()" style="width: 18px; height: 18px; cursor: pointer; accent-color: #6366f1;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-weight: 700; color: #1e293b; font-size: 16px;">${item.student_name}</span>
                            <span style="background: ${pointsColor}15; color: ${pointsColor}; padding: 2px 10px; border-radius: 20px; font-weight: 800; font-size: 14px;">${sign}${item.change_amount}</span>
                        </div>
                        <div style="font-size: 13px; color: #64748b; margin-top: 6px;">
                            <i class="fas fa-tag" style="margin-right: 4px; font-size: 11px;"></i>${item.reason} 
                            <span style="margin-left: 10px; color: #94a3b8;"><i class="fas fa-user-edit" style="margin-right: 4px; font-size: 11px;"></i>${item.teacher}</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="processAudit(${item.id}, 'approve')" 
                                style="background: #ecfdf5; color: #10b981; border: none; padding: 6px 15px; border-radius: 8px; font-weight: 700; font-size: 13px; cursor: pointer; transition: all 0.2s;">
                            åŒæ„
                        </button>
                        <button onclick="processAudit(${item.id}, 'reject')" 
                                style="background: #fff1f2; color: #ef4444; border: none; padding: 6px 15px; border-radius: 8px; font-weight: 700; font-size: 13px; cursor: pointer; transition: all 0.2s;">
                            æ‹’ç»
                        </button>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        updateAuditSelection();
        document.getElementById('auditModal').style.display = 'block';
    }

    function toggleAllAudits(checked) {
        document.querySelectorAll('.audit-item-check').forEach(cb => cb.checked = checked);
        updateAuditSelection();
    }

    function updateAuditSelection() {
        const checked = document.querySelectorAll('.audit-item-check:checked');
        const total = document.querySelectorAll('.audit-item-check').length;
        document.getElementById('auditSelectedHint').textContent = `å·²é€‰æ‹© ${checked.length} é¡¹ / å…± ${total} é¡¹`;
        document.getElementById('auditSelectAll').checked = (checked.length === total && total > 0);
    }

    async function batchProcessAudits(action) {
        const checked = document.querySelectorAll('.audit-item-check:checked');
        const ids = Array.from(checked).map(cb => parseInt(cb.dataset.id));
        
        if (ids.length === 0) return alert('è¯·å…ˆå‹¾é€‰éœ€è¦å¤„ç†çš„ç”³è¯·');
        
        const confirmText = action === 'approve' ? `ç¡®å®šä¸€é”®é€šè¿‡è¿™ ${ids.length} é¡¹ç”³è¯·å—ï¼Ÿ` : `ç¡®å®šæ‹’ç»è¿™ ${ids.length} é¡¹ç”³è¯·å—ï¼Ÿ`;
        if (!confirm(confirmText)) return;

        try {
            const res = await fetch('/api/audit/process', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    audit_ids: ids,
                    action: action
                })
            });
            
            if (res.ok) {
                // ä¸å¼¹çª—ç›´æ¥åˆ·æ–°ï¼Œä½“éªŒæ›´å¥½
                await openAuditModal(); 
                loadData(); 
            } else {
                alert('æ‰¹é‡å¤„ç†å¤±è´¥');
            }
        } catch(e) { console.error(e); }
    }

    async function processAudit(id, action) {
        // å•ä¸ªå¤„ç†é€»è¾‘ä¹Ÿå¤ç”¨ API
        try {
            const res = await fetch('/api/audit/process', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    audit_ids: [id],
                    action: action
                })
            });
            
            if(res.ok) {
                openAuditModal(); 
                loadData(); 
            }
        } catch (e) { console.error(e); }
    }
</script>
{% endblock %}