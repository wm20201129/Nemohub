{% extends "base.html" %}

{% block title %}æ²‰æµ¸å¼æ‹å–å¤§å…{% endblock %}

{% block content %}
<style>
    /* å¼ºåˆ¶é‡ç½® base.html æ ·å¼ */
    body { padding-top: 0 !important; background: #020617 !important; overflow: hidden !important; height: 100vh !important; width: 100vw !important; }
    .container { padding: 0 !important; max-width: 100% !important; margin: 0 !important; height: 100% !important; }
    .navbar { display: none !important; }

    /* é¡¶éƒ¨æˆ˜æŠ¥æ»šåŠ¨æ¡ */
    .bid-log-container {
        height: 50px; background: rgba(15, 23, 42, 0.98); border-bottom: 2px solid #be123c;
        display: flex; align-items: center; overflow: hidden; white-space: nowrap; backdrop-filter: blur(15px); z-index: 100;
    }
    #bidLog { display: flex; animation: scrollLog 20s linear infinite; align-items: center; width: max-content; }
    @keyframes scrollLog { from { transform: translateX(50vw); } to { transform: translateX(-100%); } }
    .log-item { font-size: 1.2rem; font-weight: 800; color: #f1f5f9; display: flex; align-items: center; gap: 10px; padding-right: 120px; }

    /* ä¸»å¸ƒå±€ */
    .auction-layout { display: grid; grid-template-columns: 380px 1fr; height: calc(100vh - 50px); background: #020617; }

    /* å·¦ä¾§æ§åˆ¶é¢æ¿ */
    .left-panel {
        background: #0f172a; padding: 25px; display: flex; flex-direction: column;
        border-right: 1px solid #1e293b; box-shadow: 15px 0 40px rgba(0,0,0,0.6); z-index: 10;
        overflow-y: auto;
    }
    .left-panel::-webkit-scrollbar { width: 4px; }
    .left-panel::-webkit-scrollbar-thumb { background: #1e293b; }

    .reward-preview { text-align: center; margin-bottom: 20px; }
    .reward-img { width: 100%; height: 200px; object-fit: cover; background: #020617; border-radius: 20px; border: 2px solid #be123c; }
    .reward-name { font-size: 1.8rem; font-weight: 900; color: #fff; margin-top: 10px; }
    
    .price-display-card {
        background: linear-gradient(145deg, #be123c 0%, #881337 100%);
        padding: 20px 15px; border-radius: 24px; text-align: center; 
        border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 15px 35px rgba(190, 18, 60, 0.4);
        margin-bottom: 20px;
    }
    .price-value { font-size: 5rem; font-weight: 950; display: block; line-height: 1; margin: 10px 0; color: #fff; }
    .winner-status { font-size: 1.2rem; font-weight: 900; color: #fbbf24; background: rgba(0,0,0,0.3); padding: 8px 20px; border-radius: 50px; display: inline-block; }

    .control-section { margin-top: auto; padding-top: 15px; border-top: 1px solid #1e293b; }
    .step-hint { color: #6366f1; font-weight: 900; margin-bottom: 10px; font-size: 0.85rem; }
    .inc-group { display: flex; gap: 10px; margin-bottom: 20px; }
    .inc-btn { flex: 1; padding: 15px 5px; border-radius: 15px; border: 2px solid #1e293b; background: #1e293b; color: white; font-size: 1.3rem; font-weight: 950; cursor: pointer; transition: 0.2s; text-align: center; }
    .inc-btn.active { background: #be123c; border-color: #fb7185; box-shadow: 0 0 20px rgba(190, 18, 60, 0.5); }

    .btn-finish { width: 100%; padding: 18px; border-radius: 18px; background: #10b981; color: white; font-size: 1.3rem; font-weight: 900; border: none; cursor: pointer; margin-bottom: 10px; transition: 0.3s; box-shadow: 0 10px 20px rgba(16, 185, 129, 0.2); }
    .btn-exit { width: 100%; padding: 12px; border: 1px solid #334155; background: rgba(255,255,255,0.05); color: #94a3b8; border-radius: 15px; cursor: pointer; font-weight: 800; font-size: 1rem; transition: 0.2s; }

    .right-panel { background: #020617; padding: 30px; overflow-y: auto; }
    .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    .panel-title { font-size: 1.5rem; font-weight: 900; color: #94a3b8; }
    
    .student-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; }
    .student-card { background: #0f172a; border: 1px solid #1e293b; padding: 20px 10px; border-radius: 18px; text-align: center; cursor: pointer; transition: 0.3s; }
    .student-card:hover { border-color: #be123c; background: #1e293b; transform: translateY(-3px); }
    .student-card.is-winning { background: rgba(251, 191, 36, 0.15); border: 2px solid #fbbf24; box-shadow: 0 0 30px rgba(251, 191, 36, 0.3); transform: scale(1.05); }
    .st-name { font-weight: 900; font-size: 1.1rem; color: #fff; margin-bottom: 5px; display: block; }
    .st-pts { font-size: 0.8rem; color: #6366f1; font-weight: 900; }

    .custom-alert-mask { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(10px); z-index: 10000; align-items: center; justify-content: center; }
    .custom-alert-card { background: #0f172a; border: 3px solid #be123c; border-radius: 35px; padding: 40px; width: 450px; text-align: center; }
    .alert-btn { background: #be123c; color: white; border: none; padding: 12px 35px; border-radius: 50px; font-weight: 900; cursor: pointer; margin-top: 20px; }
</style>

<div class="bid-log-container">
    <div id="bidLog">
        <span class="log-item"><i class="fas fa-gavel"></i> æ‹å–ä¸­å¿ƒæ­£å¼å¼€æ”¾ï¼å‡ºä»·æœ€é«˜è€…å¾—ï¼Œè¯·å„ä½ç«ä¹°äººå®¡æ…å‡ºä»·ã€‚</span>
    </div>
</div>

<div class="auction-layout">
    <div class="left-panel">
        <div class="reward-preview">
            <img id="rewardImg" src="" class="reward-img">
            <div id="rewardName" class="reward-name">å¥–å“åŠ è½½ä¸­...</div>
        </div>
        
        <div class="price-display-card">
            <div style="font-size: 0.8rem; opacity: 0.7; letter-spacing: 1px;">å½“å‰æœ€é«˜å‡ºä»·</div>
            <span id="currentPrice" class="price-value">0</span>
            <div id="winnerName" class="winner-status">ç­‰å¾…é¦–ä½å‡ºä»·...</div>
            <div style="font-size: 0.8rem; color: rgba(255,255,255,0.4); margin-top: 15px;">èµ·æ‹åº•åˆ†: <span id="startPrice">0</span> åˆ†</div>
        </div>

        <div class="control-section">
            <div class="step-hint"><i class="fas fa-plus-circle"></i> 1. è®¾ç½®åŠ ä»·å¹…åº¦</div>
            <div class="inc-group">
                <div class="inc-btn active" onclick="setInc(1)">+1</div>
                <div class="inc-btn" onclick="setInc(5)">+5</div>
                <div class="inc-btn" onclick="setInc(10)">+10</div>
            </div>
            <button class="btn-finish" onclick="finishAuction()">ç¡®è®¤è½æ§Œæˆäº¤</button>
            <button class="btn-exit" onclick="exitAuction()">é€€å‡ºå¤§å…</button>
        </div>
    </div>

    <div class="right-panel">
        <div class="panel-header">
            <span class="panel-title"><i class="fas fa-university"></i> <span id="auctionClassName">æ­£åœ¨åŠ è½½ç­çº§</span></span>
            <span id="stCount" style="color: #fbbf24; font-weight: 900; font-size: 1.3rem;">0 ä½ç«ä¹°äºº</span>
        </div>
        <div id="studentGrid" class="student-grid"></div>
    </div>
</div>

<div id="customAlert" class="custom-alert-mask">
    <div class="custom-alert-card" id="alertCard">
        <div id="alertIcon" style="font-size: 4rem; color: #be123c; margin-bottom: 20px;"><i class="fas fa-exclamation-circle"></i></div>
        <div id="alertTitle" style="font-size: 1.8rem; font-weight: 900; color: #fff; margin-bottom: 10px;">æç¤º</div>
        <div id="alertMsg" style="font-size: 1.1rem; color: #94a3b8; line-height: 1.6;"></div>
        <div id="alertButtons"></div>
    </div>
</div>

<script>
    let currentAuction = null, selectedInc = 1, auctionStudents = [];

    document.addEventListener('DOMContentLoaded', loadData);

    function showCustomAlert(title, msg, type = 'error', onConfirm = null) {
        const mask = document.getElementById('customAlert'), card = document.getElementById('alertCard');
        document.getElementById('alertTitle').innerText = title;
        document.getElementById('alertMsg').innerHTML = msg;
        mask.style.display = 'flex';
        const btnContainer = document.getElementById('alertButtons');
        if (onConfirm) {
            btnContainer.innerHTML = `<button class="alert-btn" style="background:#334155; margin-right:15px;" onclick="closeAlert()">å–æ¶ˆ</button><button class="alert-btn" id="confirmOkBtn">ç¡®è®¤</button>`;
            document.getElementById('confirmOkBtn').onclick = () => { closeAlert(); onConfirm(); };
        } else {
            btnContainer.innerHTML = `<button class="alert-btn" onclick="closeAlert()">ç¡®å®š</button>`;
        }
    }

    function closeAlert() { document.getElementById('customAlert').style.display = 'none'; }

    async function loadData() {
        try {
            const sysRes = await fetch('/api/system/info');
            const sysData = await sysRes.json();
            if (sysData) document.getElementById('auctionClassName').textContent = sysData.class_name;

            const res = await fetch('/api/auction/current');
            const data = await res.json();
            if (!data) { window.location.href = '/ranking'; return; }
            
            currentAuction = data;
            document.getElementById('rewardName').textContent = data.reward_name;
            document.getElementById('rewardImg').src = data.image_path || '';
            document.getElementById('currentPrice').textContent = data.current_price;
            document.getElementById('startPrice').textContent = data.current_price;
            if (data.bidder_name) document.getElementById('winnerName').textContent = `ğŸ† é¢†å…ˆ: ${data.bidder_name}`;

            // åˆå§‹åŒ–æ»šåŠ¨æ¡ä¿¡æ¯
            addLog(`ğŸ“¢ æ­£åœ¨æ‹å–ï¼š${data.reward_name}ï¼Œèµ·æ‹ä»·ï¼š${data.current_price} åˆ†`);

            const sRes = await fetch('/api/students');
            auctionStudents = await sRes.json();
            document.getElementById('stCount').textContent = `${auctionStudents.length} ä½ç«ä¹°äºº`;
            renderStudents();
        } catch (e) { console.error(e); }
    }

    function renderStudents() {
        const grid = document.getElementById('studentGrid');
        grid.innerHTML = auctionStudents.map(s => `<div class="student-card ${currentAuction.highest_bidder_id === s.id ? 'is-winning' : ''}" onclick="handleBid(${s.id}, '${s.name}', ${s.points})"><span class="st-name">${s.name}</span><span class="st-pts">${s.points} åˆ†</span></div>`).join('');
    }

    function setInc(val) {
        selectedInc = val;
        document.querySelectorAll('.inc-btn').forEach(b => b.classList.toggle('active', parseInt(b.innerText.replace('+','')) === val));
    }

    async function handleBid(sid, name, pts) {
        const newAmt = parseInt(currentAuction.current_price) + selectedInc;
        if (pts < newAmt) { showCustomAlert('ç§¯åˆ†ä¸è¶³', `<b>${name}</b> å½“å‰ä»…æœ‰ ${pts} åˆ†ï¼Œæ— æ³•å‚ä¸ ${newAmt} åˆ†çš„å‡ºä»·ã€‚`); return; }

        const res = await fetch('/api/auction/bid', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ auction_id: currentAuction.id, student_id: sid, amount: newAmt })
        });

        if (res.ok) {
            currentAuction.current_price = newAmt;
            currentAuction.highest_bidder_id = sid;
            currentAuction.bidder_name = name;
            document.getElementById('currentPrice').textContent = newAmt;
            document.getElementById('winnerName').textContent = `ğŸ† é¢†å…ˆ: ${name}`;
            
            // æ›´æ–°æ»šåŠ¨åŠ¨æ€ï¼šæ˜¾ç¤ºå¼ºåŠ¿å–Šåˆ†å’Œå¥–å“å½“å‰æ€»ä»·å€¼
            addLog(`ğŸ”¥ ${name} å¼ºåŠ¿å–Šåˆ† +${selectedInc}ï¼ å¥–å“å½“å‰ä»·å€¼ï¼š${newAmt} åˆ†`);
            
            // å±€éƒ¨æ›´æ–°è¯¥å­¦ç”Ÿçš„æ˜¾ç¤ºç§¯åˆ†
            const s = auctionStudents.find(x => x.id === sid);
            if(s) s.points = pts - newAmt; 
            
            renderStudents();
        }
    }

    function addLog(msg) {
        const log = document.getElementById('bidLog');
        const span = document.createElement('span');
        span.className = 'log-item';
        span.innerHTML = `<i class="fas fa-bullhorn" style="color:#fbbf24"></i> ${msg}`;
        log.prepend(span);
    }

    async function finishAuction() {
        const msg = currentAuction.highest_bidder_id ? `ç¡®å®šä»¥ <b>${currentAuction.current_price} åˆ†</b>æˆäº¤ç»™ <b>${currentAuction.bidder_name}</b> å—ï¼Ÿ` : "ç¡®è®¤æµæ‹ï¼Ÿ";
        showCustomAlert('æˆäº¤ç¡®è®¤', msg, 'confirm', async () => {
            const res = await fetch('/api/auction/finish', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ auction_id: currentAuction.id }) });
            if (res.ok) window.location.href = '/ranking';
        });
    }

    function exitAuction() {
        showCustomAlert('é€€å‡º', 'ç¡®è®¤é€€å‡ºï¼Ÿ', 'confirm', () => { window.location.href = '/ranking'; });
    }
</script>
{% endblock %}