{% extends "base.html" %}

{% block title %}学生管理{% endblock %}

{% block content %}
<style>
    /* 导入模态框特定样式 */
    #importModal .modal-content {
        display: flex;
        flex-direction: column;
        max-width: 600px; /* 默认宽度 */
        height: 90vh; /* 最大高度限制为视口高度的90% */
        max-height: 800px; /* 固定最大高度 */
        box-shadow: 0 10px 25px rgba(0,0,0,0.1); /* 柔和阴影 */
        border-radius: 12px;
        overflow: hidden; /* 防止内容溢出模态框自身 */
    }

    #importModal .modal-body {
        flex: 1; /* 占据剩余空间 */
        overflow-y: auto; /* 允许内容滚动 */
        padding: 20px; /* 内部填充 */
        display: flex;
        flex-direction: column; /* 内部元素垂直排列 */
        gap: 20px; /* 元素间距 */
    }

    #importModal .modal-footer {
        padding: 15px 20px;
        border-top: 1px solid #f1f5f9;
        background-color: #fcfcfc;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        flex-shrink: 0; /* 防止被挤压 */
    }
    
    /* 美化滚动条 */
    #importModal .modal-body::-webkit-scrollbar { width: 6px; }
    #importModal .modal-body::-webkit-scrollbar-track { background: #f1f5f9; }
    #importModal .modal-body::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    #importModal .modal-body::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    /* 响应式调整 */
    @media (max-width: 768px) {
        #importModal .modal-content {
            height: 95vh;
            max-width: 95%;
            margin: 2.5vh auto; /* 垂直居中 */
        }

        /* 页面头部适配 */
        .page-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }

        .header-actions {
            width: 100%;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .header-actions .btn {
            width: 100%;
            justify-content: center;
        }
        
        /* 表格容器适配 */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        /* 强制表格不换行，保证横向滚动体验 */
        .beautify-table {
            min-width: 800px; 
        }
    }

    @media (max-width: 576px) {
        #importModal .modal-content {
            max-width: 98%;
            height: 98vh;
            margin: 1vh auto;
        }
        #importModal .modal-body {
            padding: 15px;
            gap: 15px;
        }
        #importModal .modal-footer {
            padding: 10px 15px;
        }
        
        /* 小屏幕下按钮堆叠 */
        .header-actions {
            grid-template-columns: 1fr;
        }
    }
</style>
<div class="page-header">
    <h1><i class="fas fa-users"></i> 学生管理</h1>
    <div class="header-actions">
        <button class="btn btn-primary" onclick="showAddStudentModal()">
            <i class="fas fa-user-plus"></i> 添加学生
        </button>
        <!-- 添加导入导出按钮 -->
        <button class="btn btn-success" onclick="showImportModal()">
            <i class="fas fa-file-import"></i> Excel导入
        </button>
        <button class="btn btn-secondary" onclick="exportStudents()">
            <i class="fas fa-download"></i> 导出名单
        </button>
    </div>
</div>

<!-- Excel导入模态框 -->
<div id="importModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-file-import"></i> Excel导入学生</h2>
            <span class="close" onclick="closeImportModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="import-instructions">
                <h3><i class="fas fa-info-circle"></i> 导入说明</h3>
                <ul>
                    <li>下载模板文件，按格式填写学生信息</li>
                    <li>Excel文件必须包含"姓名"和"学号"列</li>
                    <li>"分组"列可选，如果分组不存在会自动创建</li>
                    <li>"初始积分"列可选，默认为0</li>
                </ul>
                <div class="import-actions">
                    <button class="btn btn-info" onclick="downloadTemplate()">
                        <i class="fas fa-download"></i> 下载模板
                    </button>
                </div>
            </div>
            
            <div class="import-form-content"> <!-- 新增的 wrapper -->
                <form id="importForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="import-class"><i class="fas fa-school"></i> 选择班级 *</label>
                        <select id="import-class" required>
                            <option value="">请选择班级</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="excel-file"><i class="fas fa-file-excel"></i> 选择Excel文件 *</label>
                        <div class="file-upload">
                            <input type="file" id="excel-file" accept=".xlsx,.xls" required
                                   onchange="handleFileSelect(this)">
                            <div class="file-info" id="file-info">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <span>点击选择或拖拽Excel文件到此区域</span>
                                <p class="file-hint">支持 .xlsx 和 .xls 格式</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="auto-create-group" checked>
                            <span>自动创建不存在的分组</span>
                        </label>
                    </div>
                </form>
                
                <div class="import-progress" id="import-progress" style="display: none;">
                    <h4><i class="fas fa-spinner fa-spin"></i> 正在导入...</h4>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <div class="progress-text" id="progress-text">正在处理...</div>
                </div>
                
                <div class="import-results" id="import-results" style="display: none;">
                    <h4><i class="fas fa-check-circle"></i> 导入完成</h4>
                    <div class="results-summary">
                        <p>成功：<span id="success-count" class="success-count">0</span> 条</p>
                        <p>失败：<span id="fail-count" class="fail-count">0</span> 条</p>
                    </div>
                    <div class="error-list" id="error-list">
                        <!-- 错误列表将在这里显示 -->
                    </div>
                    <div class="results-actions">
                        <button class="btn btn-primary" onclick="closeImportModalAndRefresh()">
                            完成并刷新列表
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer form-actions"> <!-- 移到 modal-content 底部 -->
            <button type="button" class="btn btn-secondary" onclick="closeImportModal()">取消</button>
            <button type="button" class="btn btn-primary" onclick="importStudents()">
                <i class="fas fa-upload"></i> 开始导入
            </button>
        </div>
    </div>
</div>

<!-- 美化后的筛选工具栏 -->
<div class="beauty-filter-bar">
    <div class="beauty-filter-group">
        <label class="beauty-filter-label">
            <i class="fas fa-filter"></i>
            班级筛选：
        </label>
        <select class="beauty-select" id="student-class-select" onchange="loadStudents()">
            <option value="">所有班级</option>
            <!-- 班级选项会动态加载 -->
        </select>
    </div>
    
    <div class="beauty-filter-group">
        <button class="beauty-action-btn beauty-btn-all" onclick="selectAllStudents()">
            <i class="fas fa-check-square"></i>
            全选
        </button>
        <button class="beauty-action-btn beauty-btn-clear" onclick="deselectAllStudents()">
            <i class="fas fa-times-circle"></i>
            取消全选
        </button>
    </div>
    
    <div class="beauty-search-box">
        <i class="fas fa-search"></i>
        <input 
            type="text" 
            id="student-search" 
            placeholder="搜索学生姓名或学号..." 
            oninput="searchStudents()"
        >
    </div>
</div>

<!-- 美化后的学生表格 -->
<div class="table-container">
    <table class="beautify-table">
        <thead>
            <tr>
                <th style="width: 60px;">
                    <input 
                        type="checkbox" 
                        class="beauty-checkbox"
                        id="select-all" 
                        onchange="toggleSelectAll()"
                    >
                </th>
                <th style="width: 80px;">序号</th>
                <th style="width: 120px;">
                    <i class="fas fa-id-card"></i>
                    学号
                </th>
                <th style="width: 150px;">
                    <i class="fas fa-user"></i>
                    姓名
                </th>
                <th style="width: 120px;">
                    <i class="fas fa-star"></i>
                    当前积分
                </th>
                <th style="width: 180px;">
                    <i class="fas fa-calendar-alt"></i>
                    加入时间
                </th>
                <th style="width: 220px;">
                    <i class="fas fa-cogs"></i>
                    操作
                </th>
            </tr>
        </thead>
        <tbody id="students-table-body">
            <!-- 学生数据会动态插入到这里 -->
        </tbody>
    </table>
    
    <!-- 美化后的分页控件 -->
    <div class="beauty-pagination">
        <button class="beauty-page-btn" onclick="previousPage()" id="prev-btn">
            <i class="fas fa-chevron-left"></i>
        </button>
        
        <span class="beauty-page-info" id="page-info">第 1 页</span>
        
        <button class="beauty-page-btn" onclick="nextPage()" id="next-btn">
            <i class="fas fa-chevron-right"></i>
        </button>
        
        <span class="beauty-page-info">
            共 <span id="student-count">0</span> 名学生
        </span>
    </div>
</div>

<!-- 添加/编辑学生模态框 -->
<div id="studentModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="studentModalTitle"><i class="fas fa-user-plus"></i> 添加学生</h2>
            <span class="close" onclick="closeStudentModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="studentForm" onsubmit="saveStudent(event)">
                <input type="hidden" id="studentId">
                <div class="form-group">
                    <label for="studentName"><i class="fas fa-user"></i> 姓名 *</label>
                    <input type="text" id="studentName" required placeholder="请输入学生姓名">
                </div>
                <div class="form-group">
                    <label for="studentNumber"><i class="fas fa-id-card"></i> 学号 *</label>
                    <input type="text" id="studentNumber" required placeholder="请输入学号">
                </div>
                <div class="form-group">
                    <label for="studentClass"><i class="fas fa-school"></i> 班级 *</label>
                    <select id="studentClass" required>
                        <option value="">请选择班级</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeStudentModal()">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 学生详情模态框 -->
<div id="studentDetailModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-user-circle"></i> 学生详情</h2>
            <span class="close" onclick="closeStudentDetailModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="student-profile">
                <div class="profile-header">
                    <div class="profile-avatar">
                        <i class="fas fa-user-graduate"></i>
                    </div>
                    <div class="profile-info">
                        <h3 id="detail-name"></h3>
                        <p><i class="fas fa-id-card"></i> 学号：<span id="detail-id"></span></p>
                        <p><i class="fas fa-star"></i> 积分：<span id="detail-points"></span></p>
                    </div>
                </div>
                
                <div class="points-history">
                    <h4><i class="fas fa-history"></i> 积分历史</h4>
                    <div class="history-list" id="points-history">
                        <!-- 积分历史将在这里显示 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentPage = 1;
let studentsPerPage = 10;
let allStudents = [];

document.addEventListener('DOMContentLoaded', function() {
    loadClassesForStudents();
    loadStudents();
});

// 加载学生列表函数
async function loadStudents() {
    const classId = document.getElementById('student-class-select').value;
    
    if (!classId) {
        allStudents = [];
        renderStudentsTable();
        return;
    }
    
    try {
        const response = await fetch(`/api/classes/${classId}/students`);
        allStudents = await response.json();
        
        currentPage = 1;
        renderStudentsTable();
    } catch (error) {
        console.error('加载学生失败:', error);
        if (typeof showToast === 'function') {
            showToast('加载学生失败', 'error');
        }
    }
}

// 渲染学生表格（使用美化样式）
function renderStudentsTable() {
    const tbody = document.getElementById('students-table-body');
    const startIndex = (currentPage - 1) * studentsPerPage;
    const endIndex = startIndex + studentsPerPage;
    const pageStudents = allStudents.slice(startIndex, endIndex);
    
    tbody.innerHTML = '';
    
    if (pageStudents.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="padding: 60px 20px;">
                    <div class="beauty-empty-state">
                        <i class="fas fa-users"></i>
                        <p>暂无学生数据</p>
                        <p style="font-size: 14px; margin-top: 10px; color: #a0aec0;">
                            请先添加学生或选择其他班级
                        </p>
                    </div>
                </td>
            </tr>
        `;
    } else {
        pageStudents.forEach((student, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <input 
                        type="checkbox" 
                        class="beauty-checkbox"
                        id="table-student-${student.id}"
                        onchange="toggleStudentSelection(${student.id}, this.checked)"
                    >
                </td>
                <td>${startIndex + index + 1}</td>
                <td>
                    <strong>${student.student_id}</strong>
                </td>
                <td>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="student-avatar" style="width: 32px; height: 32px; font-size: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                            ${student.name ? student.name.charAt(0) : '?'}
                        </div>
                        ${student.name}
                    </div>
                </td>
                <td>
                    <span class="beauty-points-badge" style="display: inline-block; padding: 6px 14px; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #2d3748; border-radius: 20px; font-weight: 600; font-size: 13px; box-shadow: 0 2px 8px rgba(168, 237, 234, 0.3); min-width: 50px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.5);">
                        ${student.points || 0}
                        <span style="font-size: 12px; opacity: 0.8;">分</span>
                    </span>
                </td>
                <td>
                    <span style="color: #718096; font-size: 13px;">
                        ${student.created_at ? formatDate(student.created_at) : '未知'}
                    </span>
                </td>
                <td>
                    <div class="beauty-action-buttons" style="display: flex; gap: 8px;">
                        <button class="beauty-btn" style="width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; transition: all 0.3s ease; font-size: 14px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%); color: white;" 
                                onclick="viewStudentDetails(${student.id})" 
                                title="查看详情">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="beauty-btn" style="width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; transition: all 0.3s ease; font-size: 14px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); background: linear-gradient(135deg, #ffd166 0%, #f9a826 100%); color: white;" 
                                onclick="editStudent(${student.id})" 
                                title="编辑信息">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="beauty-btn" style="width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; transition: all 0.3s ease; font-size: 14px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); background: linear-gradient(135deg, #00b894 0%, #00a085 100%); color: white;" 
                                onclick="showSinglePointsModal(${student.id})" 
                                title="积分操作">
                            <i class="fas fa-star"></i>
                        </button>
                        <button class="beauty-btn" style="width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; transition: all 0.3s ease; font-size: 14px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); background: linear-gradient(135deg, #ff7675 0%, #d63031 100%); color: white;" 
                                onclick="deleteStudent(${student.id})" 
                                title="删除学生">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
    }
    
    // 更新分页信息
    updatePaginationInfo();
}

// 更新分页信息
function updatePaginationInfo() {
    const studentCount = document.getElementById('student-count');
    const pageInfo = document.getElementById('page-info');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    
    if (studentCount) studentCount.textContent = allStudents.length;
    if (pageInfo) pageInfo.textContent = `第 ${currentPage} 页`;
    
    const totalPages = Math.ceil(allStudents.length / studentsPerPage);
    if (prevBtn) prevBtn.disabled = currentPage <= 1;
    if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
}

// 上一页
function previousPage() {
    if (currentPage > 1) {
        currentPage--;
        renderStudentsTable();
    }
}

// 下一页
function nextPage() {
    const totalPages = Math.ceil(allStudents.length / studentsPerPage);
    if (currentPage < totalPages) {
        currentPage++;
        renderStudentsTable();
    }
}

// 搜索学生
function searchStudents() {
    const searchTerm = document.getElementById('student-search').value.toLowerCase();
    
    if (!searchTerm) {
        currentPage = 1;
        renderStudentsTable();
        return;
    }
    
    const filteredStudents = allStudents.filter(student => 
        student.name.toLowerCase().includes(searchTerm) || 
        student.student_id.toLowerCase().includes(searchTerm)
    );
    
    const tbody = document.getElementById('students-table-body');
    tbody.innerHTML = '';
    
    if (filteredStudents.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="padding: 60px 20px;">
                    <div class="beauty-empty-state">
                        <i class="fas fa-search"></i>
                        <p>未找到匹配的学生</p>
                    </div>
                </td>
            </tr>
        `;
    } else {
        filteredStudents.forEach((student, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <input 
                        type="checkbox" 
                        class="beauty-checkbox"
                        id="table-student-${student.id}"
                        onchange="toggleStudentSelection(${student.id}, this.checked)"
                    >
                </td>
                <td>${index + 1}</td>
                <td><strong>${student.student_id}</strong></td>
                <td>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="student-avatar" style="width: 32px; height: 32px; font-size: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                            ${student.name ? student.name.charAt(0) : '?'}
                        </div>
                        ${student.name}
                    </div>
                </td>
                <td>
                    <span class="beauty-points-badge" style="display: inline-block; padding: 6px 14px; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #2d3748; border-radius: 20px; font-weight: 600; font-size: 13px; box-shadow: 0 2px 8px rgba(168, 237, 234, 0.3); min-width: 50px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.5);">
                        ${student.points || 0}
                        <span style="font-size: 12px; opacity: 0.8;">分</span>
                    </span>
                </td>
                <td>
                    <span style="color: #718096; font-size: 13px;">
                        ${student.created_at ? formatDate(student.created_at) : '未知'}
                    </span>
                </td>
                <td>
                    <div class="beauty-action-buttons" style="display: flex; gap: 8px;">
                        <button class="beauty-btn" style="width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; transition: all 0.3s ease; font-size: 14px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%); color: white;" 
                                onclick="viewStudentDetails(${student.id})" 
                                title="查看详情">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="beauty-btn" style="width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; transition: all 0.3s ease; font-size: 14px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); background: linear-gradient(135deg, #ffd166 0%, #f9a826 100%); color: white;" 
                                onclick="editStudent(${student.id})" 
                                title="编辑信息">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="beauty-btn" style="width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; transition: all 0.3s ease; font-size: 14px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); background: linear-gradient(135deg, #00b894 0%, #00a085 100%); color: white;" 
                                onclick="showSinglePointsModal(${student.id})" 
                                title="积分操作">
                            <i class="fas fa-star"></i>
                        </button>
                        <button class="beauty-btn" style="width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; transition: all 0.3s ease; font-size: 14px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); background: linear-gradient(135deg, #ff7675 0%, #d63031 100%); color: white;" 
                                onclick="deleteStudent(${student.id})" 
                                title="删除学生">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
    }
    
    const studentCount = document.getElementById('student-count');
    if (studentCount) {
        studentCount.textContent = `${filteredStudents.length} 名学生（已过滤）`;
    }
}

// 全选学生
function selectAllStudents() {
    const checkboxes = document.querySelectorAll('#students-table-body input[type="checkbox"]');
    checkboxes.forEach(cb => {
        cb.checked = true;
        const match = cb.id.match(/table-student-(\d+)/);
        if (match) {
            const studentId = parseInt(match[1]);
            if (!window.selectedStudents) window.selectedStudents = new Set();
            window.selectedStudents.add(studentId);
        }
    });
    updateSelectAllCheckbox();
}

// 取消全选
function deselectAllStudents() {
    const checkboxes = document.querySelectorAll('#students-table-body input[type="checkbox"]');
    checkboxes.forEach(cb => {
        cb.checked = false;
        const match = cb.id.match(/table-student-(\d+)/);
        if (match) {
            const studentId = parseInt(match[1]);
            if (window.selectedStudents) {
                window.selectedStudents.delete(studentId);
            }
        }
    });
    updateSelectAllCheckbox();
}

// 切换学生选择
function toggleStudentSelection(studentId, isSelected) {
    if (!window.selectedStudents) window.selectedStudents = new Set();
    const id = Number(studentId);
    if (isSelected) {
        window.selectedStudents.add(id);
    } else {
        window.selectedStudents.delete(id);
    }
    updateSelectAllCheckbox();
}

// 更新全选复选框状态
function updateSelectAllCheckbox() {
    const selectAllCheckbox = document.getElementById('select-all');
    if (!selectAllCheckbox) return;
    
    const checkboxes = document.querySelectorAll('#students-table-body input[type="checkbox"]');
    if (checkboxes.length === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
        return;
    }
    
    const boxes = Array.from(checkboxes);
    const allChecked = boxes.every(box => box.checked);
    const someChecked = boxes.some(box => box.checked);
    
    selectAllCheckbox.checked = allChecked;
    selectAllCheckbox.indeterminate = !allChecked && someChecked;
}

// 切换全选
function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('select-all');
    if (!selectAllCheckbox) return;
    
    const isChecked = selectAllCheckbox.checked;
    const checkboxes = document.querySelectorAll('#students-table-body input[type="checkbox"]');
    
    checkboxes.forEach(cb => {
        cb.checked = isChecked;
        const match = cb.id.match(/table-student-(\d+)/);
        if (match) {
            const studentId = parseInt(match[1]);
            if (!window.selectedStudents) window.selectedStudents = new Set();
            if (isChecked) {
                window.selectedStudents.add(studentId);
            } else {
                window.selectedStudents.delete(studentId);
            }
        }
    });
}

// 格式化日期
function formatDate(dateString) {
    if (!dateString) return '未知';
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch (error) {
        return '未知';
    }
}

// 页面加载完成后添加美化样式
document.addEventListener('DOMContentLoaded', function() {
    // 动态添加美化样式
    setTimeout(function() {
        if (!document.getElementById('beautify-styles')) {
            const style = document.createElement('style');
            style.id = 'beautify-styles';
            style.textContent = `
                .beauty-filter-bar {
                    background: white;
                    padding: 20px;
                    border-radius: 16px;
                    margin-bottom: 24px;
                    box-shadow: 0 2px 16px rgba(0, 0, 0, 0.06);
                    display: flex;
                    flex-wrap: wrap;
                    gap: 16px;
                    align-items: center;
                }
                
                .beauty-filter-group {
                    display: flex;
                    align-items: center;
                    gap: 10px;
                }
                
                .beauty-filter-label {
                    font-weight: 600;
                    color: #4a5568;
                    font-size: 14px;
                    display: flex;
                    align-items: center;
                    gap: 6px;
                }
                
                .beauty-filter-label i {
                    color: #667eea;
                }
                
                .beauty-select {
                    padding: 10px 16px;
                    border: 2px solid #e2e8f0;
                    border-radius: 12px;
                    background: white;
                    font-size: 14px;
                    color: #2d3748;
                    min-width: 180px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    outline: none;
                }
                
                .beauty-select:focus {
                    border-color: #667eea;
                    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
                }
                
                .beauty-action-btn {
                    padding: 10px 22px;
                    border: none;
                    border-radius: 12px;
                    font-weight: 600;
                    font-size: 14px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    display: inline-flex;
                    align-items: center;
                    gap: 8px;
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                }
                
                .beauty-action-btn:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                }
                
                .beauty-btn-all {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                }
                
                .beauty-btn-clear {
                    background: linear-gradient(135deg, #f7f9fc 0%, #e2e8f0 100%);
                    color: #4a5568;
                    border: 1px solid #cbd5e0;
                }
                
                .beauty-search-box {
                    flex: 1;
                    position: relative;
                    min-width: 280px;
                }
                
                .beauty-search-box input {
                    width: 100%;
                    padding: 12px 16px 12px 48px;
                    border: 2px solid #e2e8f0;
                    border-radius: 12px;
                    font-size: 14px;
                    transition: all 0.3s ease;
                    background: white;
                }
                
                .beauty-search-box input:focus {
                    border-color: #667eea;
                    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
                    outline: none;
                }
                
                .beauty-search-box i {
                    position: absolute;
                    left: 16px;
                    top: 50%;
                    transform: translateY(-50%);
                    color: #a0aec0;
                    font-size: 16px;
                }
                
                .beautify-table {
                    width: 100%;
                    border-collapse: separate;
                    border-spacing: 0;
                    border-radius: 16px;
                    overflow: hidden;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
                    background: white;
                    font-size: 14px;
                }
                
                .beautify-table thead {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                }
                
                .beautify-table th {
                    padding: 16px 20px;
                    color: white;
                    font-weight: 600;
                    text-align: left;
                    border: none;
                    position: relative;
                }
                
                .beautify-table th:not(:last-child)::after {
                    content: '';
                    position: absolute;
                    right: 0;
                    top: 50%;
                    transform: translateY(-50%);
                    height: 60%;
                    width: 1px;
                    background: rgba(255, 255, 255, 0.3);
                }
                
                .beautify-table tbody tr {
                    transition: all 0.2s ease;
                    border-bottom: 1px solid #f0f0f0;
                }
                
                .beautify-table tbody tr:last-child {
                    border-bottom: none;
                }
                
                .beautify-table tbody tr:hover {
                    background-color: #f8f9ff;
                    transform: translateY(-1px);
                }
                
                .beautify-table td {
                    padding: 14px 20px;
                    color: #333;
                    vertical-align: middle;
                }
                
                .beauty-checkbox {
                    width: 20px;
                    height: 20px;
                    border-radius: 6px;
                    border: 2px solid #cbd5e0;
                    background: white;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    position: relative;
                    appearance: none;
                    -webkit-appearance: none;
                }
                
                .beauty-checkbox:checked {
                    background: #667eea;
                    border-color: #667eea;
                }
                
                .beauty-checkbox:checked::after {
                    content: '✓';
                    position: absolute;
                    color: white;
                    font-size: 14px;
                    font-weight: bold;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                }
                
                .beauty-empty-state {
                    text-align: center;
                    padding: 60px 20px;
                    color: #718096;
                }
                
                .beauty-empty-state i {
                    font-size: 64px;
                    margin-bottom: 20px;
                    opacity: 0.3;
                    color: #667eea;
                }
                
                .beauty-empty-state p {
                    font-size: 16px;
                    margin: 0;
                    font-weight: 500;
                }
                
                .beauty-pagination {
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 8px;
                    padding: 20px;
                    background: white;
                    border-radius: 16px;
                    margin-top: 24px;
                    box-shadow: 0 2px 16px rgba(0, 0, 0, 0.06);
                }
                
                .beauty-page-btn {
                    width: 40px;
                    height: 40px;
                    border-radius: 12px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    background: #f7fafc;
                    border: 1px solid #e2e8f0;
                    color: #4a5568;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    font-weight: 600;
                    border: none;
                }
                
                .beauty-page-btn:hover:not(:disabled) {
                    background: #667eea;
                    color: white;
                    border-color: #667eea;
                }
                
                .beauty-page-btn:disabled {
                    opacity: 0.5;
                    cursor: not-allowed;
                }
                
                .beauty-page-info {
                    font-size: 14px;
                    color: #4a5568;
                    font-weight: 600;
                    margin: 0 16px;
                }
                
                @media (max-width: 768px) {
                    .beauty-filter-bar {
                        flex-direction: column;
                        align-items: stretch;
                    }
                    
                    .beauty-filter-group {
                        width: 100%;
                    }
                    
                    .beauty-select {
                        width: 100%;
                    }
                    
                    .beauty-search-box {
                        min-width: 100%;
                    }
                    
                    .beautify-table th,
                    .beautify-table td {
                        padding: 12px 16px;
                    }
                }
            `;
            document.head.appendChild(style);
            console.log('美化样式已加载');
        }
    }, 100);
});
</script>
{% endblock %}