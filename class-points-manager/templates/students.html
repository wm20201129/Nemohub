{% extends "base.html" %}

{% block title %}班级成员中心{% endblock %}

{% block content %}
<style>
    .member-container { display: grid; grid-template-columns: 280px 1fr; gap: 25px; margin-top: 10px; }
    .group-panel { background: white; border-radius: 24px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); height: fit-content; position: sticky; top: 90px; }
    .group-panel h3 { margin: 0 0 20px 0; font-size: 1.1rem; font-weight: 800; display: flex; align-items: center; gap: 10px; }
    .group-list { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
    .group-card { padding: 12px 15px; border-radius: 15px; border: 1px solid #f1f5f9; display: flex; align-items: center; justify-content: space-between; cursor: pointer; transition: 0.2s; }
    .group-card:hover { border-color: var(--primary); background: #f8faff; }
    .group-card.active { border-color: var(--primary); background: #eef2ff; box-shadow: 0 4px 10px rgba(99, 102, 241, 0.1); }
    .group-info { display: flex; align-items: center; gap: 10px; }
    .group-dot { width: 12px; height: 12px; border-radius: 50%; }
    .group-name { font-weight: 700; font-size: 14px; }
    .group-count { font-size: 12px; color: #94a3b8; }
    .student-panel { background: white; border-radius: 24px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
    .table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
    .search-box { position: relative; flex: 1; min-width: 200px; }
    .search-box i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #cbd5e1; }
    .search-box input { width: 100%; padding: 10px 15px 10px 40px; border: 2px solid #f1f5f9; border-radius: 12px; outline: none; transition: 0.2s; }
    .search-box input:focus { border-color: var(--primary); }
    .beautify-table { width: 100%; border-collapse: collapse; }
    .beautify-table th { text-align: left; padding: 15px; color: #64748b; font-weight: 700; font-size: 13px; border-bottom: 2px solid #f1f5f9; }
    .beautify-table td { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 14px; vertical-align: middle; }
    .stu-avatar { width: 35px; height: 35px; border-radius: 10px; background: #eef2ff; color: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: 800; }
    .group-tag { padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: 700; }
    @media (max-width: 992px) { .member-container { grid-template-columns: 1fr; } .group-panel { position: static; } }
</style>

<div class="member-container">
    <div class="group-panel">
        <!-- 班主任配置 (高级版) -->
        <div style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); padding: 20px; border-radius: 24px; margin-bottom: 30px; box-shadow: 0 10px 20px rgba(99, 102, 241, 0.2); color: white; position: relative; overflow: hidden;">
            <div style="position: absolute; right: -15px; bottom: -15px; opacity: 0.1; font-size: 80px;">
                <i class="fas fa-user-tie"></i>
            </div>
            <div style="font-size: 10px; opacity: 0.8; font-weight: 900; margin-bottom: 12px; letter-spacing: 1px; text-transform: uppercase;">Class Captain</div>
            <div style="display: flex; align-items: center; gap: 12px;">
                <div style="width: 45px; height: 45px; border-radius: 15px; background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; font-size: 20px; border: 1px solid rgba(255,255,255,0.3);">
                    <i class="fas fa-id-badge"></i>
                </div>
                <div style="flex: 1;">
                    <input type="text" id="teacherNameInput" 
                           style="border: none; background: transparent; font-weight: 900; font-size: 18px; color: white; width: 100%; outline: none; padding: 4px 0;" 
                           placeholder="姓名" onblur="updateTeacherName(this)"
                           onfocus="this.style.borderBottom='2px solid rgba(255,255,255,0.5)'"
                           onkeypress="if(event.key==='Enter') this.blur()">
                    <div style="font-size: 11px; opacity: 0.7; margin-top: 2px;">班级最高管理员</div>
                </div>
            </div>
        </div>
        <h3><i class="fas fa-layer-group" style="color:var(--primary)"></i> 小组建设</h3>
        <div id="groupListView" class="group-list"></div>
        <button class="btn btn-primary" style="width:100%; border-radius:12px;" onclick="showGroupModal()"><i class="fas fa-plus"></i> 创建新小组</button>
    </div>
    <div class="student-panel">
        <div class="table-header">
            <h2 style="margin:0; font-size:1.3rem; font-weight:900;">全班名单</h2>
            <div class="search-box"><i class="fas fa-search"></i><input type="text" id="stuSearch" placeholder="搜索姓名或学号..." oninput="filterStudents()"></div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-primary" onclick="showAddStudentModal()"><i class="fas fa-user-plus"></i> 新增学生</button>
                <button class="btn btn-success" onclick="showImportModal()"><i class="fas fa-file-import"></i> 批量导入</button>
            </div>
        </div>
        <div style="overflow-x: auto;">
            <table class="beautify-table">
                <thead><tr><th>学生姓名</th><th>学号</th><th>所属小组</th><th>当前积分</th><th style="text-align:right;">操作</th></tr></thead>
                <tbody id="studentTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- 弹窗部分保持一致 -->
<div id="groupModal" class="modal"><div class="modal-content" style="max-width: 350px;"><div class="modal-header"><h3>小组配置</h3><span class="close" onclick="closeModal('groupModal')">&times;</span></div><div class="modal-body" style="padding:20px;"><input type="hidden" id="editGroupId"><div class="form-group"><label>小组名称</label><input type="text" id="groupNameInput" class="form-control"></div><div class="form-group"><label>代表颜色</label><input type="color" id="groupColorInput" value="#6366f1" style="height:50px; padding:2px;"></div><button class="btn btn-primary" style="width:100%;" onclick="saveGroup()">保存小组</button></div></div></div>
<div id="studentModal" class="modal"><div class="modal-content" style="max-width: 400px;"><div class="modal-header"><h3 id="stuModalTitle">学生信息</h3><span class="close" onclick="closeModal('studentModal')">&times;</span></div><div class="modal-body" style="padding:20px;"><input type="hidden" id="editStuId"><div class="form-group"><label>学生姓名</label><input type="text" id="stuNameInput" class="form-control" required></div><div class="form-group"><label>学号</label><input type="text" id="stuCodeInput" class="form-control" required></div><div class="form-group"><label>所属小组</label><select id="stuGroupSelect" class="form-control"></select></div><button class="btn btn-primary" style="width:100%;" onclick="saveStudent()">保存信息</button></div></div></div>
<!-- 弹窗：批量导入中心 (高级版) -->
<div id="importModal" class="modal">
    <div class="modal-content" style="max-width: 550px; border-radius: 32px; overflow: hidden;">
        <div class="modal-header" style="background: #10b981; color: white; padding: 20px 30px;">
            <h3 style="margin:0; font-size: 1.2rem;"><i class="fas fa-file-import"></i> 成员批量录入中心</h3>
            <span class="close" onclick="closeModal('importModal')" style="color:white; opacity:0.8;">&times;</span>
        </div>
        <div class="modal-body" style="padding:30px;">
            <!-- 第一步 -->
            <div style="display: flex; gap: 20px; align-items: flex-start; margin-bottom: 30px; position: relative;">
                <div style="width: 32px; height: 32px; border-radius: 50%; background: #10b981; color: white; display: flex; align-items: center; justify-content: center; font-weight: 900; flex-shrink: 0; z-index: 2;">1</div>
                <div style="position: absolute; left: 15px; top: 32px; bottom: -30px; width: 2px; background: #f1f5f9; z-index: 1;"></div>
                <div style="flex: 1;">
                    <h4 style="margin: 0 0 8px 0; font-size: 15px; color: #1e293b;">获取标准填报模板</h4>
                    <p style="font-size: 12px; color: #94a3b8; margin-bottom: 12px;">请务必使用系统生成的模板，以保证数据格式正确。</p>
                    <div onclick="downloadTemplate()" style="background: #f0fdf4; border: 2px dashed #10b981; padding: 15px; border-radius: 16px; text-align: center; cursor: pointer; transition: 0.2s;" onmouseover="this.style.background='#dcfce7'">
                        <i class="fas fa-file-excel" style="font-size: 24px; color: #10b981; margin-bottom: 8px;"></i>
                        <div style="color: #059669; font-weight: 800; font-size: 13px;">点击下载：成员导入模板.xlsx</div>
                    </div>
                </div>
            </div>

            <!-- 第二步 -->
            <div style="display: flex; gap: 20px; align-items: flex-start; margin-bottom: 10px;">
                <div style="width: 32px; height: 32px; border-radius: 50%; background: #10b981; color: white; display: flex; align-items: center; justify-content: center; font-weight: 900; flex-shrink: 0; z-index: 2;">2</div>
                <div style="flex: 1;">
                    <h4 style="margin: 0 0 8px 0; font-size: 15px; color: #1e293b;">上传填好的文件</h4>
                    <p style="font-size: 12px; color: #94a3b8; margin-bottom: 15px;">支持批量创建小组、同步初始积分。</p>
                    
                    <div style="position: relative; background: #f8fafc; border: 2px solid #edf2f7; border-radius: 16px; padding: 20px; text-align: center;">
                        <input type="file" id="excelFile" accept=".xlsx" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;" onchange="updateFileName(this)">
                        <div id="fileUploadHint">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 30px; color: #cbd5e1; margin-bottom: 10px;"></i>
                            <div style="color: #64748b; font-size: 13px; font-weight: 600;">点击此处选择文件</div>
                        </div>
                    </div>
                </div>
            </div>

            <button class="btn btn-success" style="width:100%; margin-top:30px; height: 55px; border-radius: 18px; font-size: 16px; font-weight: 900; box-shadow: 0 10px 20px rgba(16, 185, 129, 0.2);" onclick="doImport()">
                <i class="fas fa-check-circle"></i> 确认并开始同步名单
            </button>
        </div>
    </div>
</div>


{% endblock %}

{% block scripts %}
<script>
let allGroups = [], allStudents = [], currentGroupId = null;

document.addEventListener('DOMContentLoaded', loadAllData);

async function loadAllData() {
    try {
        // 1. 获取系统信息 (班主任姓名)
        const sysRes = await fetch('/api/system/info');
        const sysData = await sysRes.json();
        if (sysData) {
            document.getElementById('teacherNameInput').value = sysData.teacher_name || '';
        }

        // 2. 获取小组和学生
        const [gRes, sRes] = await Promise.all([fetch('/api/groups'), fetch('/api/students')]);
        allGroups = await gRes.json();
        allStudents = await sRes.json();
        renderGroups();
        renderStudents(allStudents);
        updateGroupSelects();
    } catch(e) { console.error(e); }
}

async function updateTeacherName(el) {
    const newName = el.value.trim();
    if (!newName) return;
    
    try {
        // 先获取现有班级名，确保不被覆盖
        const infoRes = await fetch('/api/system/info');
        const info = await infoRes.json();
        
        const res = await fetch('/api/system/setup', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ class_name: info.class_name, teacher_name: newName })
        });
        if (res.ok) {
            // 提示成功并刷新导航栏
            el.style.color = '#10b981';
            setTimeout(() => { el.style.color = '#1e293b'; }, 1000);
            if(window.fetchNavInfo) fetchNavInfo(); // 如果 base.html 的函数可用
        }
    } catch(e) { console.error(e); }
}

function renderGroups() {
    const container = document.getElementById('groupListView');
    if(!container) return;
    let html = `<div class="group-card ${currentGroupId===null?'active':''}" onclick="filterByGroup(null)"><div class="group-info"><div class="group-dot" style="background:#64748b"></div><div class="group-name">全班名单</div></div><div class="group-count">${allStudents.length}人</div></div>`;
    html += allGroups.map(g => `<div class="group-card ${currentGroupId===g.id?'active':''}" onclick="filterByGroup(${g.id})"><div class="group-info"><div class="group-dot" style="background:${g.color}"></div><div class="group-name">${g.name}</div></div><div style="display:flex;align-items:center;gap:8px;"><div class="group-count">${g.student_count||0}人</div><button onclick="event.stopPropagation();editGroup(${g.id},'${g.name}','${g.color}')" style="border:none;background:none;color:#cbd5e1;cursor:pointer;"><i class="fas fa-cog"></i></button></div></div>`).join('');
    container.innerHTML = html;
}

function renderStudents(data) {
    const tbody = document.getElementById('studentTableBody');
    if(!tbody) return;
    tbody.innerHTML = data.map(s => `<tr><td><div style="display:flex;align-items:center;gap:10px;"><div class="stu-avatar">${s.name?s.name[0]:'?'}</div><b>${s.name}</b></div></td><td style="color:#94a3b8;">${s.student_id}</td><td>${s.group_name?`<span class="group-tag" style="background:${s.group_color}15;color:${s.group_color}">${s.group_name}</span>`:'未分组'}</td><td><b style="color:var(--primary);font-size:16px;">${s.points}</b></td><td style="text-align:right;"><button onclick="editStudent(${s.id})" style="border:none;background:none;color:#6366f1;cursor:pointer;margin-right:10px;"><i class="fas fa-edit"></i></button><button onclick="deleteStudent(${s.id})" style="border:none;background:none;color:#cbd5e1;cursor:pointer;"><i class="fas fa-trash-alt"></i></button></td></tr>`).join('') || '<tr><td colspan="5" style="text-align:center;padding:50px;color:#cbd5e1;">暂无名单</td></tr>';
}

function filterByGroup(gid) { currentGroupId = gid; renderGroups(); filterStudents(); }
function filterStudents() {
    const kw = document.getElementById('stuSearch').value.toLowerCase();
    let res = allStudents;
    if(currentGroupId !== null) res = res.filter(s => s.group_id === currentGroupId);
    if(kw) res = res.filter(s => s.name.toLowerCase().includes(kw) || s.student_id.includes(kw));
    renderStudents(res);
}

function updateGroupSelects() {
    const s = document.getElementById('stuGroupSelect');
    if(s) s.innerHTML = '<option value="">-- 未分组 --</option>' + allGroups.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
}

function showGroupModal() { document.getElementById('editGroupId').value=''; document.getElementById('groupNameInput').value=''; document.getElementById('groupModal').style.display='block'; }
function editGroup(id, n, c) { document.getElementById('editGroupId').value=id; document.getElementById('groupNameInput').value=n; document.getElementById('groupColorInput').value=c; document.getElementById('groupModal').style.display='block'; }
async function saveGroup() {
    const id = document.getElementById('editGroupId').value;
    const data = { name: document.getElementById('groupNameInput').value, color: document.getElementById('groupColorInput').value };
    await fetch(id ? `/api/groups/${id}` : '/api/groups', { method: id?'PUT':'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
    closeModal('groupModal'); loadAllData();
}

function showAddStudentModal() { document.getElementById('editStuId').value=''; document.getElementById('stuNameInput').value=''; document.getElementById('stuCodeInput').value=''; document.getElementById('studentModal').style.display='block'; }
function editStudent(id) { const s = allStudents.find(x => x.id === id); document.getElementById('editStuId').value=s.id; document.getElementById('stuNameInput').value=s.name; document.getElementById('stuCodeInput').value=s.student_id; document.getElementById('stuGroupSelect').value=s.group_id||''; document.getElementById('studentModal').style.display='block'; }
async function saveStudent() {
    const id = document.getElementById('editStuId').value;
    const data = { name: document.getElementById('stuNameInput').value, student_id: document.getElementById('stuCodeInput').value, group_id: document.getElementById('stuGroupSelect').value || null };
    await fetch(id ? `/api/students/${id}` : '/api/students', { method: id?'PUT':'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
    closeModal('studentModal'); loadAllData();
}

async function deleteStudent(id) { if(confirm('确定删除吗？')) { await fetch(`/api/students/${id}`, {method:'DELETE'}); loadAllData(); } }
function downloadTemplate() { window.location.href = '/api/students/template'; }
function showImportModal() { document.getElementById('importModal').style.display='block'; }
function closeModal(id) { document.getElementById(id).style.display='none'; }

function updateFileName(input) {
    const hint = document.getElementById('fileUploadHint');
    if (input.files && input.files[0]) {
        hint.innerHTML = `
            <i class="fas fa-file-excel" style="font-size: 30px; color: #10b981; margin-bottom: 10px;"></i>
            <div style="color: #10b981; font-size: 13px; font-weight: 800;">已选择：${input.files[0].name}</div>
        `;
    }
}

async function doImport() {
    const f = document.getElementById('excelFile').files[0]; if(!f) return alert('请选择文件');
    const fd = new FormData(); fd.append('file', f);
    await fetch('/api/students/import', { method:'POST', body:fd });
    alert('导入成功'); closeModal('importModal'); loadAllData();
}
</script>
{% endblock %}