{% extends "base.html" %}

{% block title %}家校合作{% endblock %}

{% block content %}
<style>
    .report-container { max-width: 1100px; margin: 0 auto; }
    .stat-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: white; padding: 24px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 20px; }
    .stat-icon { width: 56px; height: 56px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
    
    .student-list-card { background: white; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); overflow: hidden; }
    .card-header { padding: 20px 30px; border-bottom: 1px solid #edf2f7; display: flex; justify-content: space-between; align-items: center; }
    
    .student-table { width: 100%; border-collapse: collapse; }
    .student-table th { background: #f8fafc; padding: 15px 25px; text-align: left; color: #64748b; font-weight: 600; font-size: 13px; text-transform: uppercase; }
    .student-table td { padding: 15px 25px; border-bottom: 1px solid #edf2f7; vertical-align: middle; }
    
    .eval-btn { padding: 6px 12px; border-radius: 8px; border: 1px solid #e2e8f0; background: white; color: #4a5568; cursor: pointer; transition: all 0.2s; }
    .eval-btn:hover { border-color: #667eea; color: #667eea; }
    
    .eval-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
    .eval-box { background: white; border-radius: 20px; width: 90%; max-width: 500px; padding: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
</style>

<div class="report-container">
    <div class="stat-cards">
        <div class="stat-card">
            <div class="stat-icon" style="background: #eef2ff; color: #6366f1;"><i class="fas fa-users"></i></div>
            <div>
                <div style="font-size: 14px; color: #64748b;">班级总人数</div>
                <div id="totalStudents" style="font-size: 24px; font-weight: 700; color: #1e293b;">-</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background: #f0fdf4; color: #10b981;"><i class="fas fa-chart-line"></i></div>
            <div>
                <div style="font-size: 14px; color: #64748b;">平均积分</div>
                <div id="avgPoints" style="font-size: 24px; font-weight: 700; color: #1e293b;">-</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background: #fff7ed; color: #f59e0b;"><i class="fas fa-medal"></i></div>
            <div>
                <div style="font-size: 14px; color: #64748b;">最高积分</div>
                <div id="topStudent" style="font-size: 24px; font-weight: 700; color: #1e293b;">-</div>
            </div>
        </div>
    </div>

    <div class="student-list-card">
        <div class="card-header">
            <div style="display: flex; align-items: center; gap: 15px;">
                <h2 style="margin: 0; font-size: 1.25rem;">学生学情档案</h2>
                <select id="reportClassSelect" class="form-control" style="width: 180px; padding: 8px; border-radius: 8px;" onchange="loadReportData()">
                    <option value="">选择班级...</option>
                </select>
            </div>
            <button class="btn btn-success" style="background: #10b981; color: white;" onclick="exportReport()">
                <i class="fas fa-file-excel"></i> 导出期末档案
            </button>
        </div>
        <div style="overflow-x: auto;">
            <table class="student-table">
                <thead>
                    <tr>
                        <th>学生姓名</th>
                        <th>所属小组</th>
                        <th>当前总分</th>
                        <th>老师最新寄语</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="studentReportBody">
                    <!-- JS 生成 -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 评价弹窗 -->
<div id="evalModal" class="eval-modal">
    <div class="eval-box">
        <h3 id="evalTitle" style="margin-top: 0; margin-bottom: 20px;">寄语学生</h3>
        <p style="color: #718096; font-size: 0.9rem; margin-bottom: 15px;">写给家长和孩子的心里话，将同步到学情报告中。</p>
        <textarea id="evalContent" class="form-control" style="height: 150px; margin-bottom: 20px; padding: 15px; border-radius: 12px; border: 2px solid #edf2f7;" placeholder="例如：本周课堂表现进步很大，希望能继续保持！"></textarea>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-secondary" style="flex: 1; border-radius: 10px;" onclick="closeEvalModal()">取消</button>
            <button class="btn btn-primary" style="flex: 1; border-radius: 10px;" onclick="saveEvaluation()">保存并发布</button>
        </div>
    </div>
</div>

<script>
    let currentStudentId = null;

    document.addEventListener('DOMContentLoaded', () => {
        loadClasses();
    });

    async function loadClasses() {
        try {
            const res = await fetch('/api/classes');
            const classes = await res.json();
            const select = document.getElementById('reportClassSelect');
            select.innerHTML = '';
            classes.forEach(c => {
                select.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            });
            if(classes.length > 0) {
                select.value = classes[0].id;
                loadReportData();
            }
        } catch (e) { console.error(e); }
    }

    async function loadReportData() {
        const classId = document.getElementById('reportClassSelect').value;
        if(!classId) return;

        try {
            const res = await fetch(`/api/classes/${classId}/students`);
            const students = await res.json();
            
            document.getElementById('totalStudents').textContent = students.length;
            const totalPoints = students.reduce((sum, s) => sum + s.points, 0);
            document.getElementById('avgPoints').textContent = students.length ? (totalPoints / students.length).toFixed(1) : 0;
            
            const sorted = [...students].sort((a,b) => b.points - a.points);
            document.getElementById('topStudent').textContent = sorted.length ? sorted[0].name : '-';

            const tbody = document.getElementById('studentReportBody');
            tbody.innerHTML = '';
            
            for(let s of students) {
                // 并发请求优化（实际应合并API，这里先保持逻辑清晰）
                const evalRes = await fetch(`/api/students/${s.id}/evaluation`);
                const evals = await evalRes.json();
                const lastEval = evals.length ? evals[0].content : '<span style="color:#cbd5e1">还没有寄语...</span>';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <div style="font-weight: 600; color: #2d3748;">${s.name}</div>
                        <div style="font-size: 12px; color: #94a3b8;">${s.student_id}</div>
                    </td>
                    <td>${s.group_name ? `<span class="badge" style="background:#f0f9ff; color:#3b82f6;">${s.group_name}</span>` : '-'}</td>
                    <td><span style="font-weight: 700; color: #6366f1;">${s.points}</span></td>
                    <td style="max-width: 350px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 14px; color: #4a5568;">${lastEval}</td>
                    <td>
                        <button class="eval-btn" title="写评语" onclick="openEvalModal(${s.id}, '${s.name}')">
                            <i class="fas fa-comment-dots"></i> 寄语
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            }
        } catch (e) { console.error(e); }
    }

    function openEvalModal(id, name) {
        currentStudentId = id;
        document.getElementById('evalTitle').textContent = `给 ${name} 同学寄语`;
        document.getElementById('evalContent').value = '';
        document.getElementById('evalModal').style.display = 'flex';
        setTimeout(() => document.getElementById('evalContent').focus(), 100);
    }

    function closeEvalModal() { document.getElementById('evalModal').style.display = 'none'; }

    async function saveEvaluation() {
        const content = document.getElementById('evalContent').value.trim();
        if(!content) return;

        try {
            const res = await fetch(`/api/students/${currentStudentId}/evaluation`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ content: content })
            });
            if(res.ok) {
                closeEvalModal();
                loadReportData();
            }
        } catch (e) { console.error(e); }
    }

    function exportReport() {
        const classId = document.getElementById('reportClassSelect').value;
        if(!classId) return;
        window.location.href = `/api/classes/${classId}/export_report`;
    }
</script>
{% endblock %}