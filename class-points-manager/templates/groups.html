{% extends "base.html" %}

{% block title %}分组管理{% endblock %}

{% block content %}
<style>
    /* 移动端响应式样式 */
    @media (max-width: 768px) {
        /* 头部堆叠 */
        .page-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }

        .header-actions {
            width: 100%;
        }

        .header-actions .btn {
            width: 100%;
            justify-content: center;
        }

        /* 班级选择器 */
        .class-selector {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 10px;
        }

        .class-selector select {
            width: 100%;
        }

        /* 表格头部 */
        .table-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }

        .table-actions {
            width: 100%;
        }

        .search-box {
            width: 100%;
        }

        .search-box input {
            width: 100%;
        }

        /* 分组列表网格 */
        .groups-grid {
            grid-template-columns: 1fr;
        }

        /* 分组详情弹窗 */
        .profile-header {
            flex-direction: column;
            text-align: center;
        }

        .profile-icon {
            margin: 0 auto;
        }

        .group-actions .action-buttons {
            flex-direction: column;
        }

        .group-actions .btn {
            width: 100%;
            justify-content: center;
        }

        /* 模态框通用 */
        .modal-content {
            width: 95% !important;
            margin: 20px auto;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .class-selector { padding: 15px; }
        .group-ranking-item { padding: 12px; }
        .group-card { padding: 15px; }
        .group-card-stats { gap: 10px; }
        .stat-value { font-size: 16px; }
    }
</style>
<div class="page-header">
    <h1><i class="fas fa-layer-group"></i> 分组管理</h1>
    <div class="header-actions">
        <button class="btn btn-primary" onclick="showCreateGroupModal()">
            <i class="fas fa-plus"></i> 创建分组
        </button>
    </div>
</div>

<div class="class-selector">
    <label for="group-class-select"><i class="fas fa-school"></i> 选择班级：</label>
    <select id="group-class-select" onchange="loadGroups()">
        <option value="">请选择班级</option>
    </select>
</div>

<!-- 分组排行榜 -->
<div class="table-container">
    <div class="table-header">
        <h3><i class="fas fa-trophy"></i> 分组积分排行榜</h3>
    </div>
    
    <div class="group-ranking" id="group-ranking">
        <!-- 分组排行将通过JavaScript生成 -->
    </div>
</div>

<!-- 分组列表 -->
<div class="table-container">
    <div class="table-header">
        <h3><i class="fas fa-list"></i> 分组列表</h3>
        <div class="table-actions">
            <div class="search-box">
                <input type="text" id="group-search" placeholder="搜索分组..." onkeyup="searchGroups()">
                <i class="fas fa-search"></i>
            </div>
        </div>
    </div>
    
    <div class="groups-grid" id="groups-grid">
        <!-- 分组卡片将通过JavaScript生成 -->
    </div>
</div>

<!-- 创建分组模态框 -->
<div id="groupModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="groupModalTitle"><i class="fas fa-plus-circle"></i> 创建分组</h2>
            <span class="close" onclick="closeGroupModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="groupForm" onsubmit="saveGroup(event)">
                <input type="hidden" id="groupId">
                <div class="form-group">
                    <label for="groupName"><i class="fas fa-layer-group"></i> 分组名称 *</label>
                    <input type="text" id="groupName" required placeholder="例如：第一组、学霸组">
                </div>
                <div class="form-group">
                    <label for="groupClass"><i class="fas fa-school"></i> 所属班级 *</label>
                    <select id="groupClass" required>
                        <option value="">请选择班级</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="groupColor"><i class="fas fa-palette"></i> 分组颜色</label>
                    <input type="color" id="groupColor" value="#667eea">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeGroupModal()">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 分组详情模态框 -->
<div id="groupDetailModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-info-circle"></i> 分组详情</h2>
            <span class="close" onclick="closeGroupDetailModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="group-profile">
                <div class="profile-header">
                    <div class="profile-icon" id="detail-group-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="profile-info">
                        <h3 id="detail-group-name"></h3>
                        <p><i class="fas fa-school"></i> 班级：<span id="detail-group-class"></span></p>
                        <p><i class="fas fa-star"></i> 平均积分：<span id="detail-group-avg-points"></span></p>
                        <p><i class="fas fa-users"></i> 成员数：<span id="detail-group-member-count"></span></p>
                    </div>
                </div>
                
                <div class="group-members">
                    <h4><i class="fas fa-user-friends"></i> 成员列表</h4>
                    <div class="members-list" id="group-members-list">
                        <!-- 成员列表将在这里显示 -->
                    </div>
                </div>
                
                <div class="group-actions">
                    <h4><i class="fas fa-bolt"></i> 快速操作</h4>
                    <div class="action-buttons">
                        <button class="btn btn-success" onclick="addPointsToGroup()">
                            <i class="fas fa-plus"></i> 为全组加分
                        </button>
                        <button class="btn btn-warning" onclick="editGroupMembers()">
                            <i class="fas fa-user-edit"></i> 管理成员
                        </button>
                        <button class="btn btn-info" onclick="exportGroupData()">
                            <i class="fas fa-download"></i> 导出数据
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 管理分组成员模态框 -->
<div id="groupMembersModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-user-edit"></i> 管理分组成员</h2>
            <span class="close" onclick="closeGroupMembersModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="modal-section">
                <h4>当前成员</h4>
                <div id="current-members">
                    <!-- 当前成员列表 -->
                </div>
            </div>
            
            <div class="modal-section">
                <h4>添加新成员</h4>
                <div class="search-box" style="margin-bottom: 15px;">
                    <input type="text" id="add-member-search" placeholder="搜索学生..." onkeyup="searchStudentsForGroup()">
                    <i class="fas fa-search"></i>
                </div>
                <div id="available-students">
                    <!-- 可添加的学生列表 -->
                </div>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeGroupMembersModal()">完成</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentGroups = [];
let currentGroupId = null;

document.addEventListener('DOMContentLoaded', function() {
    loadClassesForGroups();
    loadGroups();
});
</script>
{% endblock %}