{% extends "base.html" %}

{% block title %}é¦–é¡µ{% endblock %}

{% block content %}
<style>
    /* ç§»åŠ¨ç«¯å“åº”å¼æ ·å¼ */
    @media (max-width: 768px) {
        .dashboard-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }

        .dashboard-header .btn {
            width: 100%;
            justify-content: center;
        }

        .class-selector {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: stretch;
        }

        .class-selector select {
            width: 100%;
        }

        .stats-grid {
            grid-template-columns: repeat(2, 1fr); /* å¹³æ¿/å¤§æ‰‹æœºæ˜¾ç¤ºä¸¤åˆ— */
        }

        .action-buttons {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 576px) {
        .stats-grid {
            grid-template-columns: 1fr; /* å°å±æ‰‹æœºä¸€åˆ— */
        }

        .action-buttons {
            grid-template-columns: 1fr; /* æŒ‰é’®ä¸€åˆ— */
        }

        .info-card h3, .recent-activity h3, .quick-actions h3 {
            font-size: 1.1rem;
        }
    }
</style>
<div class="dashboard">
    <div class="dashboard-header">
        <h1><i class="fas fa-tachometer-alt"></i> æ§åˆ¶é¢æ¿</h1>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-danger" onclick="startDeleteProcess()" style="background: #ef4444; color: white;">
                <i class="fas fa-trash-alt"></i> å¸è½½æ—§ç­çº§
            </button>
            <button class="btn btn-primary" onclick="showClassModal()">
                <i class="fas fa-plus"></i> åˆ›å»ºæ–°ç­çº§
            </button>
        </div>
    </div>

    <!-- å¸è½½ç­çº§å¯†ç éªŒè¯æ¨¡æ€æ¡† -->
    <div id="deleteAuthModal" class="modal" style="z-index: 1100;">
        <div class="modal-content" style="max-width: 350px; border-radius: 16px;">
            <div class="modal-header" style="background: #ef4444; color: white;">
                <h2 style="color: white; margin: 0;"><i class="fas fa-shield-alt"></i> æƒé™éªŒè¯</h2>
                <span class="close" onclick="closeModal('deleteAuthModal')" style="color: white;">&times;</span>
            </div>
            <div class="modal-body" style="padding: 25px;">
                <p style="margin-bottom: 15px; font-weight: 600; color: #4b5563;">è¯·è¾“å…¥ç®¡ç†å¯†ç ä»¥æ‰§è¡Œåˆ é™¤æ“ä½œï¼š</p>
                <input type="password" id="deletePasswordInput" class="form-control" style="font-size: 20px; text-align: center; letter-spacing: 4px; border: 2px solid #ef4444;" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢">
                <div id="deletePwdError" style="color: #ef4444; font-size: 13px; margin-top: 8px; display: none;">å¯†ç é”™è¯¯ï¼Œæ‹’ç»è®¿é—®</div>
                <button class="btn btn-danger" onclick="verifyDeletePassword()" style="width: 100%; margin-top: 20px; background: #ef4444;">ç¡®è®¤èº«ä»½</button>
            </div>
        </div>
    </div>

    <!-- å¸è½½ç­çº§é€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="classDeleteModal" class="modal" style="z-index: 1101;">
        <!-- ... åŸæœ‰çš„å†…å®¹ ... -->
        <div class="modal-content" style="max-width: 450px; border-radius: 16px;">
            <div class="modal-header" style="background: #ef4444; color: white;">
                <h2 style="color: white; margin: 0;"><i class="fas fa-exclamation-triangle"></i> å½»åº•å¸è½½ç­çº§</h2>
                <span class="close" onclick="closeModal('classDeleteModal')" style="color: white;">&times;</span>
            </div>
            <div class="modal-body" style="padding: 25px;">
                <div style="background: #fef2f2; padding: 15px; border-radius: 12px; border: 1px solid #fee2e2; margin-bottom: 20px;">
                    <p style="color: #b91c1c; margin: 0; font-size: 14px; line-height: 1.5;">
                        <strong>è­¦å‘Šï¼š</strong> æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤è¯¥ç­çº§çš„æ‰€æœ‰<strong>å­¦ç”Ÿã€ç§¯åˆ†å†å²ã€å°ç»„è®°å½•åŠè€å¸ˆè¯„è¯­</strong>ã€‚æ•°æ®ä¸€æ—¦åˆ é™¤æ— æ³•æ¢å¤ï¼
                    </p>
                </div>
                <div class="form-group">
                    <label style="font-weight: 600;">è¯·é€‰æ‹©è¦å¸è½½çš„ç­çº§ï¼š</label>
                    <select id="deleteClassSelect" class="form-control" style="margin-top: 10px; height: 45px; border: 2px solid #e5e7eb;">
                        <option value="">è¯·é€‰æ‹©ç­çº§...</option>
                    </select>
                </div>
                <button class="btn btn-danger" onclick="executeDeleteClass()" style="width: 100%; margin-top: 20px; padding: 12px; font-weight: bold; background: #ef4444;">
                    <i class="fas fa-fire"></i> ç«‹å³å½»åº•æ¸…é™¤
                </button>
            </div>
        </div>
    </div>

    <!-- å‘Šåˆ«çºªå¿µå¼¹çª— -->
    <div id="farewellModal" class="modal" style="z-index: 2000; background: rgba(255,255,255,0.9);">
        <div class="modal-content" style="max-width: 600px; border: none; background: transparent; box-shadow: none; margin-top: 15vh;">
            <div style="background: white; border-radius: 30px; padding: 60px 40px; text-align: center; box-shadow: 0 30px 60px rgba(0,0,0,0.1); border: 1px solid #eef2ff; position: relative; overflow: hidden;">
                <!-- è£…é¥°æ€§å…ƒç´  -->
                <div style="position: absolute; top: -50px; left: -50px; width: 150px; height: 150px; background: #eef2ff; border-radius: 50%; opacity: 0.5;"></div>
                <div style="position: absolute; bottom: -30px; right: -30px; width: 100px; height: 100px; background: #fff7ed; border-radius: 50%; opacity: 0.5;"></div>
                
                <div style="font-size: 4rem; color: #6366f1; margin-bottom: 30px; animation: heartBeat 2s infinite;">
                    <i class="fas fa-heart"></i>
                </div>
                
                <h2 style="font-size: 1.8rem; color: #1e293b; margin-bottom: 25px; line-height: 1.6; font-weight: 800;">
                    åŒå­¦ä»¬å‰ç¨‹ä¼¼é”¦ï¼Œæœªæ¥ä¸€å¸†é£é¡ºã€‚<br>æ°¸è¿œé“­è®°æˆ‘ä»¬çš„ <span id="farewellClassName" style="color: #6366f1; border-bottom: 3px solid #c7d2fe;"></span>
                </h2>

                <div style="background: #fff5f5; padding: 20px; border-radius: 16px; color: #e53e3e; font-weight: 600; margin-bottom: 30px; border: 1px dashed #feb2b2; line-height: 1.8; position: relative;">
                    <i class="fas fa-hands-clapping" style="font-size: 1.5rem; margin-bottom: 10px; display: block;"></i>
                    æ„Ÿè°¢ç­ä¸»ä»»ä¸å„ç§‘è€å¸ˆä¸€å¹´çš„è¾›å‹¤ä»˜å‡ºï¼Œ<br>
                    å¤§å®¶ä¸€èµ·ç»™ä»–ä»¬é¼“ä¸ªæŒå§ï¼ğŸ‘
                </div>
                
                <p style="color: #64748b; font-size: 1.1rem; margin-bottom: 40px;">æ¯•ä¸šä¸æ˜¯ç»ˆç‚¹ï¼Œè€Œæ˜¯æ–°å¾ç¨‹çš„èµ·ç‚¹ã€‚</p>
                
                <button class="btn btn-primary" onclick="location.reload()" style="padding: 15px 50px; border-radius: 50px; font-size: 1.1rem; font-weight: 700; background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); border: none; box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);">
                    çè—å›å¿†ï¼Œç»§ç»­å‡ºå‘
                </button>
            </div>
        </div>
    </div>

    <style>
        @keyframes heartBeat {
            0% { transform: scale(1); }
            14% { transform: scale(1.1); }
            28% { transform: scale(1); }
            42% { transform: scale(1.1); }
            70% { transform: scale(1); }
        }
    </style>

    <!-- ç¡®ä¿è¿™ä¸ªå…ƒç´ å­˜åœ¨ -->
    <div class="class-selector">
        <label for="class-select"><i class="fas fa-school"></i> é€‰æ‹©ç­çº§ï¼š</label>
        <select id="class-select" onchange="loadClassData()">
            <option value="">è¯·é€‰æ‹©ç­çº§</option>
        </select>
    </div>

    <div id="class-info" class="class-info" style="display: none;">
        <div class="info-card">
            <h3><i class="fas fa-info-circle"></i> ç­çº§ä¿¡æ¯</h3>
            <div class="info-content">
                <p><strong>ç­çº§åç§°ï¼š</strong><span id="class-name"></span></p>
                <p><strong>ç­ä¸»ä»»ï¼š</strong><span id="class-teacher"></span></p>
                <p><strong>åˆ›å»ºæ—¶é—´ï¼š</strong><span id="class-created"></span></p>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon" style="background-color: #4CAF50;">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-content">
                    <h3 id="total-students">0</h3>
                    <p>å­¦ç”Ÿæ€»æ•°</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon" style="background-color: #2196F3;">
                    <i class="fas fa-star"></i>
                </div>
                <div class="stat-content">
                    <h3 id="avg-points">0</h3>
                    <p>å¹³å‡ç§¯åˆ†</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon" style="background-color: #FF9800;">
                    <i class="fas fa-crown"></i>
                </div>
                <div class="stat-content">
                    <h3 id="max-points">0</h3>
                    <p>æœ€é«˜ç§¯åˆ†</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon" style="background-color: #9C27B0;">
                    <i class="fas fa-history"></i>
                </div>
                <div class="stat-content">
                    <h3 id="min-points">0</h3>
                    <p>æœ€ä½ç§¯åˆ†</p>
                </div>
            </div>
        </div>

        <div class="recent-activity">
            <h3><i class="fas fa-history"></i> æœ€è¿‘æ´»åŠ¨</h3>
            <div class="activity-list" id="recent-changes">
                <!-- æœ€è¿‘ç§¯åˆ†å˜åŠ¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>

        <div class="quick-actions">
            <h3><i class="fas fa-bolt"></i> å¿«é€Ÿæ“ä½œ</h3>
            <div class="action-buttons">
                <a href="/students" class="action-btn">
                    <i class="fas fa-user-plus"></i>
                    <span>æ·»åŠ å­¦ç”Ÿ</span>
                </a>
                <a href="/points" class="action-btn">
                    <i class="fas fa-star-half-alt"></i>
                    <span>ç®¡ç†ç§¯åˆ†</span>
                </a>
                <a href="/ranking" class="action-btn">
                    <i class="fas fa-medal"></i>
                    <span>æŸ¥çœ‹æ’è¡Œæ¦œ</span>
                </a>
                <button class="action-btn" onclick="exportData()">
                    <i class="fas fa-download"></i>
                    <span>å¯¼å‡ºæ•°æ®</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- åˆ›å»ºç­çº§æ¨¡æ€æ¡† -->
<div id="classModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-plus-circle"></i> åˆ›å»ºæ–°ç­çº§</h2>
            <span class="close" onclick="closeClassModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="classForm" onsubmit="createClass(event)">
                <div class="form-group">
                    <label for="className"><i class="fas fa-school"></i> ç­çº§åç§° *</label>
                    <input type="text" id="className" required placeholder="ä¾‹å¦‚ï¼šä¸‰å¹´çº§ä¸€ç­">
                </div>
                <div class="form-group">
                    <label for="classTeacher"><i class="fas fa-chalkboard-teacher"></i> ç­ä¸»ä»»</label>
                    <input type="text" id="classTeacher" placeholder="è¯·è¾“å…¥ç­ä¸»ä»»å§“å">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeClassModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">åˆ›å»ºç­çº§</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// ç¡®ä¿ loadClassData å‡½æ•°å­˜åœ¨
if (typeof loadClassData === 'undefined') {
    function loadClassData() {
        const classId = document.getElementById('class-select').value;
        if (!classId) {
            console.log("æ²¡æœ‰é€‰æ‹©ç­çº§");
            return;
        }
        
        console.log("åŠ è½½ç­çº§æ•°æ®ï¼Œç­çº§ID:", classId);
        // è¿™é‡Œå¯ä»¥æ·»åŠ åŠ è½½ç­çº§æ•°æ®çš„é€»è¾‘
    }
}

// ç¡®ä¿ showClassModal å‡½æ•°å­˜åœ¨
if (typeof showClassModal === 'undefined') {
    function showClassModal() {
        alert("åˆ›å»ºç­çº§åŠŸèƒ½");
        // è¿™é‡Œå¯ä»¥æ·»åŠ åˆ›å»ºç­çº§æ¨¡æ€æ¡†çš„é€»è¾‘
    }
}
</script>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadClasses();
});

// --- åˆ é™¤ç­çº§æµç¨‹é€»è¾‘ ---

function startDeleteProcess() {
    document.getElementById('deleteAuthModal').style.display = 'block';
    document.getElementById('deletePasswordInput').value = '';
    document.getElementById('deletePwdError').style.display = 'none';
    setTimeout(() => document.getElementById('deletePasswordInput').focus(), 100);
}

function closeModal(id) {
    document.getElementById(id).style.display = 'none';
}

async function verifyDeletePassword() {
    const pwd = document.getElementById('deletePasswordInput').value;
    if(!pwd) return;

    try {
        const res = await fetch('/api/verify_password', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ password: pwd })
        });
        
        if (res.ok) {
            closeModal('deleteAuthModal');
            document.getElementById('classDeleteModal').style.display = 'block';
            loadClasses(); // ç¡®ä¿ä¸‹æ‹‰æ¡†æœ‰æ•°æ®
        } else {
            document.getElementById('deletePwdError').style.display = 'block';
            document.getElementById('deletePasswordInput').value = '';
            document.getElementById('deletePasswordInput').focus();
        }
    } catch (e) {
        alert('éªŒè¯å‡ºé”™');
    }
}

async function executeDeleteClass() {
    const classSelect = document.getElementById('deleteClassSelect');
    const classId = classSelect.value;
    if (!classId) {
        alert('è¯·é€‰æ‹©è¦åˆ é™¤çš„ç­çº§');
        return;
    }

    const className = classSelect.options[classSelect.selectedIndex].text;
    
    if(!confirm(`æ­¤æ“ä½œå°†ç‰©ç†åˆ é™¤ã€${className}ã€‘çš„æ‰€æœ‰æ•°æ®ï¼ˆå­¦ç”Ÿã€ç§¯åˆ†ã€è¯„è¯­ç­‰ï¼‰ä¸”ä¸å¯æ’¤é”€ã€‚\n\næ‚¨ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ`)) {
        return;
    }

    try {
        const res = await fetch(`/api/classes/${classId}`, {
            method: 'DELETE'
        });
        
        if (res.ok) {
            // éšè—åˆ é™¤æ¡†
            closeModal('classDeleteModal');
            // æ˜¾ç¤ºå‘Šåˆ«å¼¹çª—
            document.getElementById('farewellClassName').textContent = className;
            document.getElementById('farewellModal').style.display = 'block';
        } else {
            const data = await res.json();
            alert('åˆ é™¤å¤±è´¥: ' + data.error);
        }
    } catch (e) {
        alert('ç½‘ç»œè¯·æ±‚å¤±è´¥');
    }
}

// ç»‘å®šå›è½¦é”®éªŒè¯å¯†ç 
document.getElementById('deletePasswordInput')?.addEventListener('keypress', (e) => {
    if(e.key === 'Enter') verifyDeletePassword();
});
</script>
{% endblock %}